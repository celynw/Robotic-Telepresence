<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Robotic Telepresence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Robotic Telepresence">
<meta property="og:url" content="https://celynwalters.github.io/Robotic-Telepresence/page/3/index.html">
<meta property="og:site_name" content="Robotic Telepresence">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Robotic Telepresence">
  
    <link rel="alternate" href="/atom.xml" title="Robotic Telepresence" type="application/atom+xml">
  
  
    <link rel="icon" href="/Robotic-Telepresence/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/Robotic-Telepresence/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-87037949-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/Robotic-Telepresence/" id="logo">Robotic Telepresence</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/Robotic-Telepresence/" id="subtitle">Electronic Engineering BEng final project</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/">Home</a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/Project-objectives">Project Objectives</a>
        
          <a class="main-nav-link" href="https://www.teamgantt.com/gantt/schedule/?ids=702976&public_keys=1UNWW0SIdEwg&zoom=w90&font_size=12&estimated_hours=0&assigned_resources=0&percent_complete=0&documents=0&comments=0&col_width=255&menu_view=0&resource_filter=1&name_in_bar=0&name_next_to_bar=0&resource_names=1">Gantt Chart</a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://celynwalters.github.io/Robotic-Telepresence"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-VR-feature-Angle-snapping" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/02/12/VR-feature-Angle-snapping/">VR feature: Angle snapping</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/02/12/VR-feature-Angle-snapping/" class="article-date">
  <time datetime="2017-02-12T17:59:33.000Z" itemprop="datePublished">Sun 12/02/2017 17:59</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I thought this would be an easy feature to add.<br>When drawing targets, holding the grip buttons would snap the new location to a 45-degree-quantised vector from the first position.</p>
<p>At first, I thought about comparing the actual position difference to the 45-degree vectors and using the smallest angle difference.<br>This had problems with vectors 180 degrees out from each other.</p>
<p>Then I tried normalising the position difference and comparing the position with the normalised 45-degree vectors.<br>This seems possible.</p>
<p><img src="/Robotic-Telepresence/2017/02/12/VR-feature-Angle-snapping/Angles.png" alt="This shows the angles to snap to"></p>
<hr>
<p>However, I haven’t tried to use Baxter yet, and I’m not sure of how the IK solver will project the path of the hand; it may not necessarily be a straight path, so this visualisation could be misleading.<br>Maybe a better way would be to replace the controller models with ghostly grippers which will remain at the target positions until the IK solver has finished.</p>
<p>I’ve also had a quick look into a Unity-based IK solver. They are common in games with avatars.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/02/12/VR-feature-Angle-snapping/" data-id="cj0bndq14001n1k9rqv19l1ta" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Project-meeting-9" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/02/08/Project-meeting-9/">Project meeting 9</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/02/08/Project-meeting-9/" class="article-date">
  <time datetime="2017-02-08T17:56:01.000Z" itemprop="datePublished">Wed 08/02/2017 17:56</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Safety"><a href="#Safety" class="headerlink" title="Safety"></a>Safety</h4><p>Apparently ROS has a way to set initial constraints, so that for instance, commands which tell him to move his hands into the space occupied by the table can be overridden.<br>While Baxter tends to avoid collisions with his other arms and the torso, apparently he ignores the screen on the head, so I’ll have to be careful of that.<br>If I’m going to be in VR in the robot lab, I’ll need another person to be in the room at the same time. It would be possible to start with to just not wear the headset and view the game windows on a monitor.</p>
<h4 id="Next-steps"><a href="#Next-steps" class="headerlink" title="Next steps"></a>Next steps</h4><p>Soon, another PC will be set up in the robot lab able to run Windows, then I can get started on practical development.<br>I still need to learn to use Baxter, but the environment should be set up for this already.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/02/08/Project-meeting-9/" data-id="cj0bndq09001b1k9rn9brhza4" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Adding-VR-to-Unity-Project" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/02/07/Adding-VR-to-Unity-Project/">Adding VR to Unity Project</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/02/07/Adding-VR-to-Unity-Project/" class="article-date">
  <time datetime="2017-02-07T15:47:54.000Z" itemprop="datePublished">Tue 07/02/2017 15:47</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Enabling-VR"><a href="#Enabling-VR" class="headerlink" title="Enabling VR"></a>Enabling VR</h4><p>This step was very simple.<br>A preliminary step is to ensure the Steam client is installed, along with the SteamVR application.<br>In Unity, under “Player Preferences”, tick the “Virtual Reality Supported” checkbox.<br>Done.<br>Now when SteamVR is running, pressing “Play” in Unity will focus itself in the VR headset.<br>This only enables head tracking though.<br>To get more functionality, download the free SteamVR plugin from the Unity assets store.<br>You can drag the prefabs out into the base project directory and ther controllers are shown (in the same skin as the user has set in their SteamVR preferences).<br>There seem to be some great resources for getting started, I’m using <a href="https://docs.unity3d.com/Manual/OpenVRControllers.html" target="_blank" rel="external">this page</a> for controller input.</p>
<h4 id="VR-tests"><a href="#VR-tests" class="headerlink" title="VR tests"></a>VR tests</h4><p>There seem to be many ways to access data from the headset or controllers.<br>I wrote a little script to spawn primitives at a controller’s position with a trigger press.<br>The idea is to develop it to draw commands for where to move Baxter’s hand to next.<br><figure class="highlight cs"><figcaption><span>Unity script</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ControllerTest</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line">	<span class="keyword">private</span> SteamVR_TrackedController controller;</div><div class="line">	<span class="keyword">private</span> PrimitiveType currentPrimitiveType = PrimitiveType.Sphere;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> arrowStarted = <span class="literal">false</span>;</div><div class="line">	<span class="keyword">private</span> Vector3 arrowStartPos;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		controller = GetComponent&lt;SteamVR_TrackedController&gt;();</div><div class="line">		controller.TriggerClicked += handle_trigger_clicked;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		controller.TriggerClicked -= handle_trigger_clicked;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handle_trigger_clicked</span>(<span class="params"><span class="keyword">object</span> sender, ClickedEventArgs e</span>) </span>&#123;</div><div class="line">		spawn_arrow_at_controller();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">spawn_sphere_at_controller</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> sphere = GameObject.CreatePrimitive(PrimitiveType.Sphere);</div><div class="line">		sphere.transform.position = transform.position;</div><div class="line">		sphere.transform.rotation = transform.rotation;</div><div class="line">		sphere.transform.localScale = <span class="keyword">new</span> Vector3(<span class="number">0.1</span>f, <span class="number">0.1</span>f, <span class="number">0.1</span>f);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">spawn_arrow_at_controller</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		GameObject cylinder;</div><div class="line">		<span class="keyword">if</span> (!arrowStarted) &#123;</div><div class="line">			arrowStartPos = transform.position;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			cylinder = GameObject.CreatePrimitive(PrimitiveType.Cylinder);</div><div class="line">			cylinder.transform.position = (arrowStartPos + transform.position) / <span class="number">2</span>;</div><div class="line">			cylinder.transform.rotation = transform.rotation;</div><div class="line">			cylinder.transform.localScale = <span class="keyword">new</span> Vector3(<span class="number">0.1</span>f, <span class="number">0.1</span>f, <span class="number">0.1</span>f);</div><div class="line">		&#125;</div><div class="line">		arrowStarted = !arrowStarted;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/Robotic-Telepresence/2017/02/07/Adding-VR-to-Unity-Project/Cylinders.png" alt="First, just spawning at controller position"><br><img src="/Robotic-Telepresence/2017/02/07/Adding-VR-to-Unity-Project/Midpoints.png" alt="Then, pick two points and it instantiates at the midpoint"><br>I’ll be rotating and scaling the cylinders into arrows to view the expected path of a hand.</p>
<h4 id="Drawing-arrows"><a href="#Drawing-arrows" class="headerlink" title="Drawing arrows"></a>Drawing arrows</h4><p>After some tweaking, I managed to get it to be able to drag the controllers to draw ‘arrows’.<br>I’ll need to offset them, because the controller origin can’t be visually pinpointed, so it’s difficult for the user to choose a precise location.<br>The image below shows the controller origin. I’m thinking of using the very centre of the ring.</p>
<p><img src="/Robotic-Telepresence/2017/02/07/Adding-VR-to-Unity-Project/Controller.png" alt="{Red, Green, Blue} are {X, Y, Z} respectively"></p>
<p>The script below enables functionality demonstrated in the video underneath.</p>
<figure class="highlight cs"><figcaption><span>Final Unity Script</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ControllerTest</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line">	<span class="keyword">private</span> SteamVR_TrackedController controller;</div><div class="line">	<span class="keyword">private</span> PrimitiveType currentPrimitiveType = PrimitiveType.Sphere;</div><div class="line">	<span class="keyword">public</span> GameObject prefabCylinder; <span class="comment">// Fill with arrow prefab</span></div><div class="line">	<span class="keyword">private</span> GameObject arrow; <span class="comment">// Current arrow being drawn</span></div><div class="line">	<span class="keyword">private</span> Vector3 arrowStartPos;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="comment">// Register controller callbacks</span></div><div class="line">		controller = GetComponent&lt;SteamVR_TrackedController&gt;();</div><div class="line">		controller.TriggerClicked += handle_trigger_clicked;</div><div class="line">		controller.TriggerUnclicked += handle_trigger_unclicked;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="comment">// Unegister controller callbacks</span></div><div class="line">		controller.TriggerClicked -= handle_trigger_clicked;</div><div class="line">		controller.TriggerUnclicked += handle_trigger_unclicked;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Start drawing the arrow</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handle_trigger_clicked</span>(<span class="params"><span class="keyword">object</span> sender, ClickedEventArgs e</span>) </span>&#123;</div><div class="line">		arrowStartPos = transform.position;</div><div class="line">		arrow = (GameObject)Instantiate(prefabCylinder);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Finished drawing the arrow</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handle_trigger_unclicked</span>(<span class="params"><span class="keyword">object</span> sender, ClickedEventArgs e</span>) </span>&#123;</div><div class="line">		arrow = <span class="literal">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="comment">// Handle arrow logic</span></div><div class="line">		<span class="keyword">if</span> (controller.triggerPressed) &#123;</div><div class="line">			<span class="keyword">var</span> direction = transform.position - arrowStartPos;</div><div class="line">			<span class="keyword">var</span> midpoint = direction/<span class="number">2</span>;</div><div class="line">			arrow.transform.rotation = Quaternion.FromToRotation(Vector3.up, direction);</div><div class="line">        	arrow.transform.localScale = <span class="keyword">new</span> Vector3(<span class="number">0.05</span>f, direction.magnitude/<span class="number">2</span>, <span class="number">0.05</span>f);</div><div class="line">			arrow.transform.position = midpoint + arrowStartPos;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<div class="video-container"><iframe src="//www.youtube.com/embed/0gkBvNeSKKs" frameborder="0" allowfullscreen></iframe></div>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/02/07/Adding-VR-to-Unity-Project/" data-id="cj0bndpxi00041k9rocqbqmal" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Midterm-interview" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/02/02/Midterm-interview/">Midterm interview</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/02/02/Midterm-interview/" class="article-date">
  <time datetime="2017-02-02T20:19:49.000Z" itemprop="datePublished">Thu 02/02/2017 20:19</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Main-things-to-take-away"><a href="#Main-things-to-take-away" class="headerlink" title="Main things to take away"></a>Main things to take away</h4><p>I need to really be sure on what it is I’m trying to acheive. This should come across very clearly in the final report.<br>Rather than setting my work out in the order I discovered things (chronologically), it would be clearer if I start with broad information, and reading further qould increase the detail.</p>
<p>I need to finish the project as soon as possible, to any degree of quality. Then I should work on fleshing it out.<br>Even though I work regularly there’s a risk of not finishing, which could severely limit the available marks.<br>I’ll be working on control for Baxter and implementing VR over the next couple of weeks.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/02/02/Midterm-interview/" data-id="cj0bndpyw000o1k9rxk6d1yh9" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Project-meeting-8" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/02/01/Project-meeting-8/">Project meeting 8</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/02/01/Project-meeting-8/" class="article-date">
  <time datetime="2017-02-01T22:33:01.000Z" itemprop="datePublished">Wed 01/02/2017 22:33</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Things-discussed"><a href="#Things-discussed" class="headerlink" title="Things discussed"></a>Things discussed</h4><ul>
<li>Feedback from midterm report</li>
<li>Tips for the midterm interview tomorrow</li>
<li>The existing problem with point clouds</li>
</ul>
<p>The point clouds might be getting stuck due to the sheer size of the point cloud frames.<br>If so, then cutting the resolution down could save a lot of time and processing.<br>I could test some example (smaller) clouds.<br>However, I’d expect some response from the socket node or some network activity.</p>
<p>It also could be down to the type of data, as it’s the only topic of its kind.</p>
<p>At this point, it was suggested that it might be better to directly connect the Kinect to the VR computer.<br>I’ve demonstrated some functionality for a framework for viewing ROS clouds.<br>It would free up time for working on other aspects and could be relatively straight-forward to implement and achieve good results.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/02/01/Project-meeting-8/" data-id="cj0bndq0600191k9rqgro0enn" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Final-structure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/01/31/Final-structure/">Final structure</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/01/31/Final-structure/" class="article-date">
  <time datetime="2017-01-31T23:17:07.000Z" itemprop="datePublished">Tue 31/01/2017 23:17</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I’ve started to write what could be the final few files, in terms of the main data communication functionality.</p>
<h4 id="Console-application"><a href="#Console-application" class="headerlink" title="Console application"></a>Console application</h4><p>This will be the ROS node, which connects to a serial server (socket).<br>It will subscribe to whichever topics are required and set up shared memory for each. As I can have many parallel shared spaces I think this is easier than trying to navigate a single one.<br>I’m trying a class-based approach to keep things tidy and encapsulated.<br>I had a lot of problems trying to encapsulate the callbacks (required), so in the end I’ve left some of it in <code>main()</code>.</p>
<p>As the shared memory can only be written in integers, I’ll have to convert the joint angles (floats) back in to 4xbytes. Here’s a reason to convert bytes into floats in the Unity script (point clouds).</p>
<h4 id="Unity-application"><a href="#Unity-application" class="headerlink" title="Unity application"></a>Unity application</h4><p>Once the data’s in the shared space, it will probably be just a block of integers. I’ll have to know how to read things in the correct order.<br>I’ve not worked out splitting work into individual threads yet, but I know it’s supported and doable.<br>I plan to have the VR in one (I think this might be automatic), point clouds in another (they will be intensive) and anything else in another? Perhaps keep a limit of 4 cores?</p>
<h4 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h4><p>Following <a href="/2016/12/07/Point-Cloud-from-Actual-Data/">the last time I tried this</a> I ran into the same problem.<br>Even trying to send a single point cloud over the socket, the virtual machine’s CPU jumps to around 20%, never completes, no errors are displayed but the <code>rosserial_server</code> node has silently crashed.<br>I’m hoping this is due to complications with it being the same physical machine and it being virtualised, but there’s no problems with the joint angles at all.<br>I’ll have to run this in the robot lab.</p>
<p>Using <code>std::vec</code> made sense for making a more robust program, but I had to convert it back into an array for the <code>CopyMemory()</code> function for shared memory and I ran into all sorts of endian-ness problems. They were difficult to spot as printing the contents to <code>stdout</code> didn’t show any problems.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/01/31/Final-structure/" data-id="cj0bndpy2000b1k9rtxebajjs" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Named-shared-memory-Episode-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/01/18/Named-shared-memory-Episode-3/">Named shared memory: Episode 3</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/01/18/Named-shared-memory-Episode-3/" class="article-date">
  <time datetime="2017-01-18T14:40:07.000Z" itemprop="datePublished">Wed 18/01/2017 14:40</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Inter-process-communication"><a href="#Inter-process-communication" class="headerlink" title="Inter-process communication"></a>Inter-process communication</h4><p>Following the success of <a href="/Robotic-Telepresence/2016/12/03/Named-Shared-Memory-Episode-2/">Named Shared Memory: Episode 2</a>, it wasn’t too far to be able to see the message generated in one process in the Unity debug log.<br>As long as it’s known what data is expected at which offsets it can be reconstructed.<br>The only function data types available are:</p>
<blockquote>
<ul>
<li>Byte</li>
<li>Int16</li>
<li>Int32</li>
<li>Int64</li>
<li>IntPtr</li>
</ul>
</blockquote>
<p>Luckily these can be cast to whatever you like.</p>
<p><img src="/Robotic-Telepresence/2017/01/18/Named-Shared-Memory-Episode-3/Message.png" alt="Process writing the message can be started before or after Unity starts"></p>
<p>I’ve had trouble casting to floats from Int32s.<br>I’ve come across ‘BitConverter.ToSingle’ which does the same task as the byte/float union in my console application.<br>Perhaps I could use a <code>.dll</code> after all.</p>
<h4 id="Project-structure"><a href="#Project-structure" class="headerlink" title="Project structure"></a>Project structure</h4><p>I’ve decided to make the console application the smallest middle-man possible, so it will only transfer the data to the shared memory.<br>Any multithreading will be solely handled by Unity.<br>I’ve managed to get this working, but it has not reduced the time yet (still at ~19 seconds for a single frame).<br>I think this is because earlier it was reading from a stream, writing to another stream and having that stream being read which could pipeline.<br>Now it’s only doint the first read from a stream.<br>I will see what it’s like by combining the <code>NamedSharedMemory</code> project and the <code>rosserial</code> projects, cutting out any streams.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/01/18/Named-shared-memory-Episode-3/" data-id="cj0bndpzh000s1k9rp1vfvp2b" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-PCL-point-clouds" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/01/03/PCL-point-clouds/">PCL point clouds</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/01/03/PCL-point-clouds/" class="article-date">
  <time datetime="2017-01-03T21:06:59.000Z" itemprop="datePublished">Tue 03/01/2017 21:06</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>Now I have a list of 200kB files (<code>xaa</code>, <code>xab</code>, <code>xac</code> etc.), split from the first PointCloud2 message in the <code>rosbag</code>.<br>Viewing the ascii <code>.pcd</code> file, I found what looked like the start of meaningful data, at point 29515.<br>Doing some arithmetic led me to the 17th file, or <code>xaq</code>.<br>I used this to confirm my program wasn’t working.</p>
<h4 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h4><p>I’ve just realised that I wasn’t discarding data properly!<br>The offsets of 4 bytes of 0, 1, 2 and 4 are required, but I wasn’t discarding 3, 5, 6 or 7!<br>Along with making sure the commas were removed: Success!!<br><img src="/Robotic-Telepresence/2017/01/03/PCL-point-clouds/Conversion Success.png" alt="Using a custom segment of data which won&#39;t return NaNs"></p>
<p>I needed to adapt the program to skip the header parts of the message to only read the data.<br>I ran it on a full message and it took a couple of minutes to finish printing, but it worked.<br>Removing the printing functionality sped it up to about 20 seconds.<br><strong>This needs to be faster!</strong><br>I can optimise the code a bit more, and it’s only running on a single core.<br>I can also get Unity to read from RAM rather than wait for stdout redirection.</p>
<h4 id="Into-Unity"><a href="#Into-Unity" class="headerlink" title="Into Unity"></a>Into Unity</h4><p>I can call the program in Unity, however it does not close automatically.<br>I realised that this is caused by redirecting standard output into Unity.<br>By completely reading everything in the buffer, it is fixed.</p>
<p>I got it to display the first 65000 points of a whole message.<br><img src="/Robotic-Telepresence/2017/01/03/PCL-point-clouds/First 65000 White.png" alt="It&#39;s white because there&#39;s a problem with the rendering I haven&#39;t realised yet."><br>65000 is the maximum number of vertices in a mesh in Unity.<br>I’ll have to split the cloud into submeshes.</p>
<h4 id="More-hindsight"><a href="#More-hindsight" class="headerlink" title="More hindsight"></a>More hindsight</h4><p>I’ve made another mistake. After a long time of trial and error, I’ve found that while you can split a mesh into submeshes, the overall limit is still 65000 points because it’s actually still one mesh.<br>The purpose of submeshes is for different materials.<br>I’ll have to make more GameObjects with their own meshes.</p>
<h4 id="Full-mesh"><a href="#Full-mesh" class="headerlink" title="Full mesh"></a>Full mesh</h4><p>A partial success, but the colours still don’t work and the rotation is wrong.<br><img src="/Robotic-Telepresence/2017/01/03/PCL-point-clouds/Full Selection.png" alt="The cloud is structured in strips, from Baxter&#39;s back to front"><br>To fix the colours, I’ve realised that the colours are supposed to be between 0 and 1, not 0 and 255.<br>To fix the rotation, I need to find out the base transformation.</p>
<h4 id="Colours"><a href="#Colours" class="headerlink" title="Colours"></a>Colours</h4><p>But the colours seem wrong.<br>Perhaps this is to do with endian-ness I didn’t account for.<br><img src="/Robotic-Telepresence/2017/01/03/PCL-point-clouds/Colours Wrong.png" alt="It&#39;s not just my eyes? I think?"><br>Yep! That was it. Now for the transformation.<br><img src="/Robotic-Telepresence/2017/01/03/PCL-point-clouds/Colours Fixed.png" alt="Phew"></p>
<h4 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h4><p>This was quite difficult to find.<br>The Googlable phrases were all quite similar, and most people were trying to <em>set</em> the transform, not <em>get</em> it.<br>I started with <code>RViz</code> again. I remember having to set the base transform for viewing the octomap.<br>This didn’t exactly help, although I saw some error messages which said:<br><figure class="highlight plain"><figcaption><span>In RViz</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Failed to transform from frame [camera_rgb_optical_frame] to frame [base]</div></pre></td></tr></table></figure></p>
<p>This gave me a bit more to go on. From the <code>PointCloud2</code> message itself, I knew it used the <code>camera_rgb_optical_frame</code>.<br>This eventually led me to <code>tf_echo</code>:<br><figure class="highlight zsh"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ rosrun tf tf_echo camera_rgb_optical_frame base</div><div class="line">At time 1479833365.881</div><div class="line">- Translation: [-0.024, -0.546, 1.873]</div><div class="line">- Rotation: <span class="keyword">in</span> Quaternion [0.708, 0.675, -0.154, 0.145]</div><div class="line">            <span class="keyword">in</span> RPY (radian) [-3.139, 0.425, 1.524]</div><div class="line">            <span class="keyword">in</span> RPY (degree) [-179.836, 24.340, 87.300]</div><div class="line"></div><div class="line">$ rosrun tf tf_echo base camera_rgb_optical_frame</div><div class="line">At time 1479833366.181</div><div class="line">- Translation: [1.270, 0.003, 1.481]</div><div class="line">- Rotation: <span class="keyword">in</span> Quaternion [0.708, 0.675, -0.154, -0.145]</div><div class="line">            <span class="keyword">in</span> RPY (radian) [-2.717, 0.022, 1.528]</div><div class="line">            <span class="keyword">in</span> RPY (degree) [-155.691, 1.276, 87.539]</div></pre></td></tr></table></figure></p>
<p>I 100% wasn’t sure which way around it was, so I tried both.<br>Using my knowledge from the <a href="/Robotic-Telepresence/2016/11/14/URDF-importer/">URDF importer</a>, I made a Unity script to convert these into the native frame.<br>By negating the X translation, rotating by -90 degrees in X, then rotating by -Z, then -Y, then +X with the values for the translation from <code>base</code> to <code>camera_rgb_optical_frame</code>, it worked:<br><img src="/Robotic-Telepresence/2017/01/03/PCL-point-clouds/Complete.png" alt="It still seems off, probably not my fault."><br>Thankfully, the point clouds are dense enough for now to not worry about them being represented by single pixels.<br>There seem to be no performance issues whatsoever.</p>
<h4 id="Still-lots-to-do"><a href="#Still-lots-to-do" class="headerlink" title="Still lots to do"></a>Still lots to do</h4><p>I still have to work out how to make this not take 20 seconds each frame, while still allowing other processes to run.<br>Not to mention bringing everything together…</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/01/03/PCL-point-clouds/" data-id="cj0bndpzi000t1k9ro0nqvrod" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/Robotic-Telepresence/page/2/">&laquo; Previous</a><a class="page-number" href="/Robotic-Telepresence/">1</a><a class="page-number" href="/Robotic-Telepresence/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/Robotic-Telepresence/page/4/">4</a><a class="page-number" href="/Robotic-Telepresence/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/Robotic-Telepresence/page/8/">8</a><a class="extend next" rel="next" href="/Robotic-Telepresence/page/4/">Next &raquo;</a>
  </nav>

</section>
        <!-- MANUALLY ADDED FOR GANTT CHART -->
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/03/">March 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/02/">February 2017</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/12/">December 2016</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/11/">November 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/10/">October 2016</a><span class="archive-list-count">14</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Celyn Walters<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/Robotic-Telepresence/" class="mobile-nav-link">Home</a>
  
    <a href="/Robotic-Telepresence/Project-objectives" class="mobile-nav-link">Project Objectives</a>
  
    <a href="https://www.teamgantt.com/gantt/schedule/?ids=702976&public_keys=1UNWW0SIdEwg&zoom=w90&font_size=12&estimated_hours=0&assigned_resources=0&percent_complete=0&documents=0&comments=0&col_width=255&menu_view=0&resource_filter=1&name_in_bar=0&name_next_to_bar=0&resource_names=1" class="mobile-nav-link">Gantt Chart</a>
  
    <a href="/Robotic-Telepresence/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/Robotic-Telepresence/fancybox/jquery.fancybox.css">
  <script src="/Robotic-Telepresence/fancybox/jquery.fancybox.pack.js"></script>


<script src="/Robotic-Telepresence/js/script.js"></script>

  </div>
</body>
</html>
