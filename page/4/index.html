<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Robotic Telepresence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Robotic Telepresence">
<meta property="og:url" content="https://celynwalters.github.io/Robotic-Telepresence/page/4/index.html">
<meta property="og:site_name" content="Robotic Telepresence">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Robotic Telepresence">
  
    <link rel="alternate" href="/atom.xml" title="Robotic Telepresence" type="application/atom+xml">
  
  
    <link rel="icon" href="/Robotic-Telepresence/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/Robotic-Telepresence/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-87037949-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/Robotic-Telepresence/" id="logo">Robotic Telepresence</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/Robotic-Telepresence/" id="subtitle">Electronic Engineering BEng final project</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/">Home</a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/Project-objectives">Project Objectives</a>
        
          <a class="main-nav-link" href="https://www.teamgantt.com/gantt/schedule/?ids=702976&public_keys=1UNWW0SIdEwg&zoom=w90&font_size=12&estimated_hours=0&assigned_resources=0&percent_complete=0&documents=0&comments=0&col_width=255&menu_view=0&resource_filter=1&name_in_bar=0&name_next_to_bar=0&resource_names=1">Gantt Chart</a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://celynwalters.github.io/Robotic-Telepresence"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Converting-point-clouds-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/01/02/Converting-point-clouds-2/">Converting point clouds 2</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/01/02/Converting-point-clouds-2/" class="article-date">
  <time datetime="2017-01-02T13:47:58.000Z" itemprop="datePublished">Mon 02/01/2017 13:47</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>To further my investigation of why I was unable to convert the PointCloud2 messages into usable values, I tried using <code>Rviz</code>, which I know can view the data properly.<br>It’s a hassle as I have to restart my PC, and I lose access to most of my development tools (rviz won’t run in a virtual machine).<br>If I can export some of the data, I’ll have something to compare the results of my program to.<br><code>rviz</code> showed how many messages were coming through, and you could select an area of points to see their data. However, you couldn’t select <em>all</em> points, or export the data.</p>
<p>Later, I came across a tool called <code>bag_to_pcd</code> <a href="http://re.je/notes/2013/capturing-point-clouds-with-pcl-tools/" target="_blank" rel="external">here</a>.<br>I converted each message in the bag to a <code>.pcd</code> file, and then converted the first one into other formats from there.<br><figure class="highlight zsh"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ sudo add-apt-repository ppa:v-launchpad-jochen-sprickerhof-de/pcl</div><div class="line">$ sudo apt update</div><div class="line">$ sudo apt install libpcl-all</div><div class="line">$ sudo apt install libpcl-all-dev</div><div class="line">$ sudo apt install ros-indigo-perception</div><div class="line"></div><div class="line">$ rosrun pcl_ros bag_to_pcd ~/Downloads/baxter.bag /camera/depth_registered/points ~/Downloads</div><div class="line">$ pcl_pcd2ply 1479833365.438671766.pcd output.ply</div><div class="line">$ pcl_convert_pcd_ascii_binary 1479833365.438671766.pcd output.pcd 0</div></pre></td></tr></table></figure></p>
<p>I was left with a binary <code>.pcd</code> file, an ascii <code>.pcd</code> file, and a binary <code>.ply</code> file (which didn’t work, unexpected eof even with trailing newline)</p>
<p>I could view them to make sure they were still OK using <code>pcd_viewer</code><br><figure class="highlight zsh"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ rosrun perception_pcl pcd_viewer output.pcd</div></pre></td></tr></table></figure></p>
<p><img src="/Robotic-Telepresence/2017/01/02/Converting-point-clouds-2/View PCL.png" alt="Incredibly buggy in my virtual machine!"></p>
<h4 id="New-information"><a href="#New-information" class="headerlink" title="New information"></a>New information</h4><p>When viewing the ascii <code>.pcd</code> file, it became apparent that huge sections at the start and end of the file was meaningless data.<br>This could help to explain why I wasn’t getting anywhere.<br>I also learned that a devices like a kinect will often output <code>nan</code> values if the incident ray wasn’t returned.</p>
<p>I’ll have to re-export the <code>rosbag</code> message, so that it’s the first message in the bag. Then I can compare my results to the actual points.<br>Hopefully then I can come up with a way to filter out the bad data efficiently.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/01/02/Converting-point-clouds-2/" data-id="cj0bndpxo00061k9rhavqp8eu" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Project-meeting-7" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2016/12/14/Project-meeting-7/">Project meeting 7</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2016/12/14/Project-meeting-7/" class="article-date">
  <time datetime="2016-12-14T12:32:16.000Z" itemprop="datePublished">Wed 14/12/2016 12:32</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Project-progress"><a href="#Project-progress" class="headerlink" title="Project progress"></a>Project progress</h4><p>I’m still not sure why I had so much trouble converting 3D-space points back into floats.<br>However, there should be a library in <code>ROS</code> for PCL, which is what I should be using after all.</p>
<h4 id="Interim-report-plan-feedback"><a href="#Interim-report-plan-feedback" class="headerlink" title="Interim report plan feedback"></a>Interim report plan feedback</h4><p>I received some feedback about the structure of the report.<br>I should think about it more logically, and get somebody else to read it.<br>I’ll also be including multiple revisions of Gantt charts, including an<br>up-to-date version.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2016/12/14/Project-meeting-7/" data-id="cj0bndq0400181k9riahtdj90" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Converting-point-clouds" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2016/12/07/Converting-point-clouds/">Converting point clouds</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2016/12/07/Converting-point-clouds/" class="article-date">
  <time datetime="2016-12-07T21:33:29.000Z" itemprop="datePublished">Wed 07/12/2016 21:33</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I spent a long time trying to write something which formats a message into data useable by Unity for generating a vertex mesh.<br>It should have been easier, but I ran into a lot of issues.</p>
<p>The general idea is to convert 4 bytes of the 32-byte point data to a float for each of X, Y, and Z.<br>The message even states the endian-ness of this layout (<a href="http://docs.ros.org/api/sensor_msgs/html/msg/PointCloud2.html" target="_blank" rel="external">documentation</a>).</p>
<p>I learned of the <strong>union</strong>:<br><figure class="highlight cpp"><figcaption><span>Conversion code</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">union</span> &#123;</div><div class="line">  <span class="keyword">float</span> f;</div><div class="line">  <span class="keyword">int</span> b[<span class="number">4</span>];</div><div class="line">&#125; data;</div></pre></td></tr></table></figure></p>
<p>I couldn’t use the whole data from a single message each time, I couldn’t even open it in a text editor as it was too large.<br>Fortunately I could split the file without even opening it.<br><figure class="highlight zsh"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ split -b 200000 PointCloud.txt</div></pre></td></tr></table></figure></p>
<p>This generated a list of 200kB files, with <code>xaa</code> being the start with the header messages.</p>
<p>Whatever I did to the conversion program, I was always getting <code>nan</code> values, or crazily small ones.<br>I read about using the pcl library to use their methods for this rather than me implementing something myself.<br>Such methods exist in <code>pcl_ros/point_cloud.h</code>. However, this resource and the resources it depends on are part of the <code>ROS</code> environment.<br>Ideally, The Windows side would do the work, so that the Linux side only publishes the related data. It shouldn’t have to know what’s on the other end.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2016/12/07/Converting-point-clouds/" data-id="cj0bndpxf00031k9rl9lu3yz7" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Point-cloud-from-actual-data" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2016/12/07/Point-cloud-from-actual-data/">Point cloud from actual data</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2016/12/07/Point-cloud-from-actual-data/" class="article-date">
  <time datetime="2016-12-07T13:03:08.000Z" itemprop="datePublished">Wed 07/12/2016 13:03</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>There were some errors in the <a href="/Robotic-Telepresence/2016/12/05/Point-Clouds-in-Unity/">previous post</a>.<br>There were 9,830,400 individual numbers in a single frame of the point cloud in the <code>rosbag</code>.<br>Looking at the <a href="http://docs.ros.org/api/sensor_msgs/html/msg/PointCloud2.html" target="_blank" rel="external">documentation</a> for the message type, and the header of the message, the number of points is far fewer.<br><figure class="highlight zsh"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ rostopic <span class="built_in">echo</span> --noarr --nostr /camera/depth_registered/points</div><div class="line">header: </div><div class="line">  seq: 16832</div><div class="line">  stamp: </div><div class="line">    secs: 1479833365</div><div class="line">    nsecs: 438671766</div><div class="line">height: 480</div><div class="line">width: 640</div><div class="line">is_bigendian: False</div><div class="line">point_step: 32</div><div class="line">row_step: 20480</div><div class="line">is_dense: False</div><div class="line">---</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><figcaption><span>Message header</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">fields: </div><div class="line">  - </div><div class="line">    name: x</div><div class="line">    offset: 0</div><div class="line">    datatype: 7</div><div class="line">    count: 1</div><div class="line">  - </div><div class="line">    name: y</div><div class="line">    offset: 4</div><div class="line">    datatype: 7</div><div class="line">    count: 1</div><div class="line">  - </div><div class="line">    name: z</div><div class="line">    offset: 8</div><div class="line">    datatype: 7</div><div class="line">    count: 1</div><div class="line">  - </div><div class="line">    name: rgb</div><div class="line">    offset: 16</div><div class="line">    datatype: 7</div><div class="line">    count: 1</div></pre></td></tr></table></figure>
<p>The width and height of the cloud from the Kinect 1 is 640x480, with 32 bytes for each point.<br><code>9830400 / (640 * 480) = 32</code><br>According to the documentation for the <a href="http://docs.ros.org/api/sensor_msgs/html/msg/PointField.html" target="_blank" rel="external">PointField</a> message, each datum uses <code>datatype: 7</code>, which is a <code>FLOAT32</code>. This means 32 bits, or 4 bytes.<br>The data values in the PointCloud2 message are of type <code>uint8</code>, which uses 8 bits, or 1 byte.<br>This means that for each point in the message, there’s space for 8x <code>float32</code>.</p>
<p>Examining the first 32 bytes of the first message, the fields described in the message header are visible:<br><figure class="highlight plain"><figcaption><span>First point in first message</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">0 0 192 127 //x</div><div class="line">0 0 192 127 //y</div><div class="line">0 0 192 127 //z</div><div class="line">0 0 0 0</div><div class="line">131 115 115 255 //rgb</div><div class="line">0 0 0 0</div><div class="line">0 0 0 0</div><div class="line">0 0 0 0</div></pre></td></tr></table></figure></p>
<p>For some reason, playing the rosbag with a windows listener subscribed to the point cloud, causes the <code>socket_node</code> to hang, even on one message, with network activity dropping to zero.<br>This happens even when minimally changed from subscribing to <code>JointStates</code>, (which works perfectly), and not storing or printing the output.<br>The same happens with octomap, which has significatnly smaller messages.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2016/12/07/Point-cloud-from-actual-data/" data-id="cj0bndpzm000v1k9r0666zj2s" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Point-clouds-in-Unity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2016/12/05/Point-clouds-in-Unity/">Point clouds in Unity</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2016/12/05/Point-clouds-in-Unity/" class="article-date">
  <time datetime="2016-12-05T23:41:03.000Z" itemprop="datePublished">Mon 05/12/2016 23:41</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>Giving the <code>NamedSharedMemory</code> a bit of a break while I focus on point clouds.<br>If I can’t get <code>NamedSharedMemory</code> to work, I’ve always got the slower less efficient stdout redirection into Unity.</p>
<h4 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h4><p>The example point clouds which I was provided with were very large.</p>
<blockquote>
<table>
<thead>
<tr>
<th>File</th>
<th>Size</th>
<th>Vertices</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kinect_Aligned_ColourFromOscar_Subsampled.ply</td>
<td>6.7MB</td>
<td>419,033</td>
</tr>
<tr>
<td>Oscar_Monocular_Reconstruction_Cloud.ply</td>
<td>17.9MB</td>
<td>396,257</td>
</tr>
<tr>
<td>Kinect_Aligned.ply</td>
<td>449.7MB</td>
<td>37,478,946</td>
</tr>
<tr>
<td>Kinect_Aligned_ColourFromOscar.ply</td>
<td>599.7MB</td>
<td>37,478,946</td>
</tr>
</tbody>
</table>
</blockquote>
<p><img src="/Robotic-Telepresence/2016/12/05/Point-Clouds-in-Unity/Subsampled.png" alt="The smallest point cloud, which has been edited by hand"><br>The best way to draw them would be to take advantage of the GPU.<br>By using a vertex shader, we can make each point in the cloud a vertex.<br>I grabbed some code from <a href="http://www.kamend.com/2014/05/rendering-a-point-cloud-inside-unity/" target="_blank" rel="external">here</a> to adapt and try out.<br>Unity only allows 65,534 vertices for each mesh, at which it is split into multiple meshes.<br>My computer, with the recommended GPU for entry-level VR had no trouble at all rendering 60,000 points in a cube.<br><img src="/Robotic-Telepresence/2016/12/05/Point-Clouds-in-Unity/60k Cube.png" alt=""><br>This is ~500 times fewer points than in the largest <code>.ply</code> file, but I don’t know how large it will <em>need</em> to be.<br>I couldn’t work out how to vary the point size. The functionality should be enabled by a script attached to the camera which specifies:<br><figure class="highlight cs"><figcaption><span>PointCLoudConfig.cs</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> UInt32 GL_VERTEX_PROGRAM_POINT_SIZE = <span class="number">0x8642</span>;</div><div class="line">glEnable(GL_VERTEX_PROGRAM_POINT_SIZE);</div></pre></td></tr></table></figure></p>
<h4 id="rosbag-Point-Cloud"><a href="#rosbag-Point-Cloud" class="headerlink" title="rosbag Point Cloud"></a><code>rosbag</code> Point Cloud</h4><p>In order to find how many points I should expect, I ran the <code>rosbag</code> step by step until a message containing the output was printed, which I redirected to a file.<br>The file caused my text editor to not be very responsive. I found the commas were only present in the list of points, so I counted them without opening the file.<br><figure class="highlight zsh"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ rosbag play ~/Downloads/baxter.bag --pause <span class="_">-l</span></div><div class="line">$ rostopic <span class="built_in">echo</span> /camera/depth_registered/points | tee ~/PointCloud.txt</div><div class="line">$ fgrep -o <span class="string">","</span> ~/PointCloud.txt | wc <span class="_">-l</span></div><div class="line">9830399</div></pre></td></tr></table></figure></p>
<p>This gave a file of 36.5MB, with 9,830,400 points, which would split into 151 meshes.</p>
<p>I wrote a little script which would create <code>X</code> number of child <code>GameObjects</code>, each drawing 60,000 points in the new shader, offset by 10 units.<br><figure class="highlight cs"><figcaption><span>CreatePointCloudObject.cs</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreatePointCloudObjects</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> num_clouds = <span class="number">0</span>;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		Material mat = Resources.Load(<span class="string">"PointCloud"</span>, <span class="keyword">typeof</span>(Material)) <span class="keyword">as</span> Material;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;num_clouds; i++) &#123;</div><div class="line">			GameObject gameObject = <span class="keyword">new</span> GameObject(<span class="string">"PointCloud fragment"</span>);</div><div class="line">			gameObject.transform.SetParent(<span class="keyword">this</span>.transform);</div><div class="line">			gameObject.AddComponent&lt;PointCloud&gt;(); <span class="comment">//MeshRenderer and MeshFilter already added by script</span></div><div class="line">			gameObject.GetComponent&lt;MeshRenderer&gt;().material = mat;</div><div class="line">			gameObject.transform.position = <span class="keyword">new</span> Vector3((<span class="keyword">float</span>)i*<span class="number">10</span>, <span class="number">0.0</span>f, <span class="number">0.0</span>f);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>When increasing <code>X</code> to 164, it also seemed to run without issue.<br><img src="/Robotic-Telepresence/2016/12/05/Point-Clouds-in-Unity/All Points.png" alt="Drawing 9,840,000 vertices with random vertex colours, at 1px per vertex"></p>
<h4 id="Changing-point-size"><a href="#Changing-point-size" class="headerlink" title="Changing point size"></a>Changing point size</h4><p>I realised that whist the <code>GL_VERTEX_PROGRAM_POINT_SIZE</code> was being enabled, it wasn’t being enabled because I was running in DirectX11.<br>By going to <code>Edit &gt; Project Settings &gt; Player &gt; Other Settings</code> and unchecking <code>Auto Graphics API for Windows</code>, I was given the option to enable OpenGLCore and move it to the top of the list.<br>Now the property was being enabled (only when viewing through the scene camera, not the editor) but I wasn’t seeing any changes.<br>I still can’t get it to work.<br><a href="http://1darray.com/blog/2012/09/01/xyz-point-cloud-data-viewer-dx11/" target="_blank" rel="external">This guy</a> seems to have a very capable asset package for point clouds, but he won’t give any information away because he’s selling his work.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2016/12/05/Point-clouds-in-Unity/" data-id="cj0bndpzo000w1k9r2jzuztsf" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Named-shared-memory-Episode-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2016/12/03/Named-shared-memory-Episode-2/">Named shared memory: Episode 2</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2016/12/03/Named-shared-memory-Episode-2/" class="article-date">
  <time datetime="2016-12-03T01:07:37.000Z" itemprop="datePublished">Sat 03/12/2016 01:07</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I did a lot of looking around, and I could find very occasional signs that some people had been able to get named shared memory working with Unity.<br>Eventually I found <a href="http://answers.unity3d.com/questions/1249732/how-to-use-shared-memory-in-unity.html" target="_blank" rel="external">this forum question</a> which showed some example code for Unity C# and other C++.<br>The C++ code I could tell had been adapted from the <a href="https://msdn.microsoft.com/en-us/library/aa366551.aspx" target="_blank" rel="external">MSDN page</a> I got mine from, which had been adapted.<br>I adapted it some more to fit the other end and made it into a Unity Script.</p>
<p>After learning I needed to use unsafe operations, I found out that to enable them you had to add a file in yout assets called <code>smcs.rsp</code>.<br>This turned out to be different if you enabled the full .NET 2.0 API compatibility level, being <code>gmcs.rsp</code>.<br>This also turned out to be depreceated, so I used <code>mcs.rsp</code> instead.<br>It should contain the line:<br><figure class="highlight plain"><figcaption><span>mcs.rsp</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-unsafe</div></pre></td></tr></table></figure></p>
<p>I couldn’t get the ends to connect. I tried removing the <code>Global\\</code> from the file mapping name. Now administrator access is no longer required.<br>In the console, It showed signs of life at the other end:<br><img src="/Robotic-Telepresence/2016/12/03/Named-shared-memory-Episode-2/Life.png" alt="Although I haven&#39;t even checked what data transfer is supposed to be happening"></p>
<p>I’ve somehow broken my Visual Studio projects which use the ROS library.<br>Including <code>&lt;windows.h&gt;</code> somehow conflicts with <code>&quot;ros.h&quot;</code>.<br>I <em>need</em> <code>windows.h</code> for <code>CreateFileMapping()</code>.<br>Fixed!<br>The solution was: <code>windows.h</code> was #defining <code>ERROR</code>, which was being used in <code>ros/Log.h</code>.<br>Adding a <code>#undef ERROR</code> at the start made it build.</p>
<h4 id="Putting-ROS-messages-into-shared-memory"><a href="#Putting-ROS-messages-into-shared-memory" class="headerlink" title="Putting ROS messages into shared memory"></a>Putting ROS messages into shared memory</h4><p>The example uses <code>CopyMemory()</code> to put a string into shared memory.<br>I’ll need to know the size of the message.<br>Looking at <code>JointState.h</code> in the ROS library in Windows, I was able to see how the joint messages were built and how to determine their sizes</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2016/12/03/Named-shared-memory-Episode-2/" data-id="cj0bndpzf000r1k9rkej87elp" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Named-shared-memory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2016/12/02/Named-shared-memory/">Named shared memory</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2016/12/02/Named-shared-memory/" class="article-date">
  <time datetime="2016-12-02T10:56:53.000Z" itemprop="datePublished">Fri 02/12/2016 10:56</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>There seem to be more easily found resources for these.</p>
<ul>
<li>Memory is broken into pages, so buffer space is rounded to the next available size</li>
</ul>
<p>In order for the data to be accessible globally, you must set the <code>Global</code> flag in its name:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TCHAR szName[] = TEXT(<span class="string">"Global\\MyFileMappingObject"</span>);</div></pre></td></tr></table></figure></p>
<p>This requires Administrator privileges (<code>SeCreateGlobalPrivilege, SE_CREATE_GLOBAL_NAME</code>).<br>Running Visual Studio as administrator is supposed to make it so that any program run in the debugger is also run with privileges.<br>This was true, as the return value from <code>GetLastError()</code> went from <code>5</code> (cannot access) to <code>2</code> (no idea).<br>I couldn’t solve this, but running the built executables outside as administrator worked as expected.</p>
<p>While I’m on the subject of learning how Visual Studio actually works, I’ve repackaged and renamed each project and put them all into one solution, which accesses a single instance of the built <code>ros_lib</code> library for <code>rosserial_windows</code>.</p>
<p>I was just trying to create a file mapping in a Unity script…</p>
<blockquote>
<p>error CS0234: The type or namespace name <code>MemoryMappedFiles</code> does not exist in the namespace <code>System.IO</code></p>
</blockquote>
<p>System.IO.MemoryMappedFiles is only available in .NET 4.0 or later, and Unity is still using .NET 3.5 (.NET 2.0 CLR), not likely to be updated for a long time. Bummer.</p>
<p>It looks like there could be a wrapper, <a href="https://github.com/tomasr/filemap/tree/master" target="_blank" rel="external">filemap</a>.<br>I got it to compile, and I’m left with a <code>.dll</code>. I’m not sure how to use it (the repository has no documentation) and I’m pretty sure I’ll have to edit it to make it compaitble with Unity so I’m not very hopeful.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2016/12/02/Named-shared-memory/" data-id="cj0bndpzl000u1k9rf5w2rhpa" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Named-pipe-dll" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2016/12/01/Named-pipe-dll/">Named pipe dll</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2016/12/01/Named-pipe-dll/" class="article-date">
  <time datetime="2016-12-01T20:56:37.000Z" itemprop="datePublished">Thu 01/12/2016 20:56</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I had to enable CLR support for the <code>System</code> namespaces.</p>
<blockquote>
<p>Project &gt; rosserial_unity Properties &gt; Configuration Properties &gt; General &gt; Project Defaults &gt; Common Language Runtime Support &gt; enable /clr</p>
</blockquote>
<p>I didn’t know that Unity keeps a track of all global classes in the assets (seems obvious now). I moved the StreamString class definition to a separate script.<br>I moved the pipe server code into a DLL. It compiled and could run, but caused Unity to hang.<br>I moved the while loop out of the <code>Main()</code> function and put it into a separate function which is to be called by Unity’s <code>Update()</code>.<br>This meant I had to make <code>PipeServer::server</code> global, which caused <code>server == null</code> to happen in some places.</p>
<p>It took a while! I ended up with this structure:</p>
<ul>
<li>A <code>.dll</code> to open a named pipe called “rospipe”. When the pipe is connected to, it would send “Hello Unity”, and then close it.</li>
<li>A <code>GameObject</code> to call the <code>.dll</code> and open the pipe. Once it’s confirmed to be open, it enables the next <code>GameObject</code>:</li>
<li>A <code>GameObject</code> which connects to the pipe “rospipe” if it exists, and listens for messages.</li>
</ul>
<p><img src="/Robotic-Telepresence/2016/12/01/Named-pipe-dll/Debug Log.png" alt="Proof. The string exists only in the .dll, and no other programs were running"></p>
<p>Maybe I will have to use <code>WaitNamedPipe</code> (<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa365800.aspx" target="_blank" rel="external">MSDN</a>)? When trying to debug, I got an error in Visual Studio:</p>
<blockquote>
<p>Exception thrown: ‘System.IO.IOException’ in System.Core.dll<br>An unhandled exception of type ‘System.IO.IOException’ occurred in System.Core.dll<br>Additional information: All pipe instances are busy.</p>
</blockquote>
<p>I also added a <code>close_pipe</code> function, now that we don’t want to necessarily close straight after initilasing. It should trigger when I stop the game using the <code>OnApplicationQuit()</code> callback.<br>It doesn’t seem to work, though.<br>Every second time I try to run the game, Unity crashes.<br>I’m using <code>PipeServer.Close()</code> which runs, but <code>PipeServer.Disconnect()</code> and <code>PipeDispose.()</code> crashed things immediately.<br>After a long time, I realised it was caused by the <code>.dll</code> having <code>close_pipe()</code> as a <code>void</code> return, but Unity had it as a <code>bool</code> return. D’Oh!<br>Now I can run the code a few times before crashing. Wow!</p>
<p>I’ve set the PipeDirection in the <code>.dll</code> to ‘Out’ rather than 2-way.<br>It took me too long to realise I had to change the other end to ‘In’…</p>
<h3 id="Oops"><a href="#Oops" class="headerlink" title="Oops."></a>Oops.</h3><p>As educational this was, I’m trying to write values which overwrite the old ones, regardless of whether they were read or not.<br>The data in named pipes MUST be read on the receiving end in the same order, FIFO.<br>I have, however, gained a much better understanding of how all of this works, and some new keywords for Googling.<br><a href="https://msdn.microsoft.com/en-us/library/aa365574%28v=vs.85%29.aspx" target="_blank" rel="external">Here</a> is a list of IPC (inter-process communication) methods provided by Windows.<br>I’ll choose one of these.</p>
<blockquote>
<table>
<thead>
<tr>
<th>Axis</th>
<th>Info</th>
</tr>
</thead>
<tbody>
<tr>
<td><del>Clipboard</del></td>
<td>The user might want to use this/overwrite the data</td>
</tr>
<tr>
<td><del>COM</del></td>
<td>This looks like it is built for other purposes, it uses ActiveX Object Services</td>
</tr>
<tr>
<td>Data Copy</td>
<td></td>
</tr>
<tr>
<td><del>DDE</del></td>
<td>“Not as efficient as newer technologies”. We need this to be as fast as possible</td>
</tr>
<tr>
<td><strong>File Mapping</strong></td>
<td>This sounds good. Programs treat the memory as their own. You can even do <em>named</em> file mapping. Many other IPC methods are based on this so generally have poorer performance</td>
</tr>
<tr>
<td><del>Mailslots</del></td>
<td>Messages are short (400 bytes) and are FIFO</td>
</tr>
<tr>
<td><del>Pipes</del></td>
<td>As mentioned, is strictly FIFO</td>
</tr>
<tr>
<td>RPC</td>
<td></td>
</tr>
<tr>
<td>Windows Sockets</td>
<td>Intended for network communications, can be TCP or UDP. Not so high performance</td>
</tr>
</tbody>
</table>
</blockquote>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2016/12/01/Named-pipe-dll/" data-id="cj0bndpz3000q1k9rume8e4on" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/Robotic-Telepresence/page/3/">&laquo; Previous</a><a class="page-number" href="/Robotic-Telepresence/">1</a><a class="page-number" href="/Robotic-Telepresence/page/2/">2</a><a class="page-number" href="/Robotic-Telepresence/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/Robotic-Telepresence/page/5/">5</a><a class="page-number" href="/Robotic-Telepresence/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/Robotic-Telepresence/page/8/">8</a><a class="extend next" rel="next" href="/Robotic-Telepresence/page/5/">Next &raquo;</a>
  </nav>

</section>
        <!-- MANUALLY ADDED FOR GANTT CHART -->
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/03/">March 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/02/">February 2017</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/12/">December 2016</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/11/">November 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/10/">October 2016</a><span class="archive-list-count">14</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Celyn Walters<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/Robotic-Telepresence/" class="mobile-nav-link">Home</a>
  
    <a href="/Robotic-Telepresence/Project-objectives" class="mobile-nav-link">Project Objectives</a>
  
    <a href="https://www.teamgantt.com/gantt/schedule/?ids=702976&public_keys=1UNWW0SIdEwg&zoom=w90&font_size=12&estimated_hours=0&assigned_resources=0&percent_complete=0&documents=0&comments=0&col_width=255&menu_view=0&resource_filter=1&name_in_bar=0&name_next_to_bar=0&resource_names=1" class="mobile-nav-link">Gantt Chart</a>
  
    <a href="/Robotic-Telepresence/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/Robotic-Telepresence/fancybox/jquery.fancybox.css">
  <script src="/Robotic-Telepresence/fancybox/jquery.fancybox.pack.js"></script>


<script src="/Robotic-Telepresence/js/script.js"></script>

  </div>
</body>
</html>
