<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Robotic Telepresence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Robotic Telepresence">
<meta property="og:url" content="https://celynwalters.github.io/Robotic-Telepresence/index.html">
<meta property="og:site_name" content="Robotic Telepresence">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Robotic Telepresence">
  
    <link rel="alternate" href="/atom.xml" title="Robotic Telepresence" type="application/atom+xml">
  
  
    <link rel="icon" href="/Robotic-Telepresence/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/Robotic-Telepresence/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-87037949-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/Robotic-Telepresence/" id="logo">Robotic Telepresence</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/Robotic-Telepresence/" id="subtitle">Electronic Engineering BEng final project</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/">Home</a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/Project-objectives">Project Objectives</a>
        
          <a class="main-nav-link" href="https://www.teamgantt.com/gantt/schedule/?ids=702976&public_keys=1UNWW0SIdEwg&zoom=w90&font_size=12&estimated_hours=0&assigned_resources=0&percent_complete=0&documents=0&comments=0&col_width=255&menu_view=0&resource_filter=1&name_in_bar=0&name_next_to_bar=0&resource_names=1">Gantt Chart</a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://celynwalters.github.io/Robotic-Telepresence"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Pose-control-of-Baxter" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/16/Pose-control-of-Baxter/">Pose control of Baxter</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/16/Pose-control-of-Baxter/" class="article-date">
  <time datetime="2017-03-15T23:33:43.000Z" itemprop="datePublished">Thu 16/03/2017 00:33</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>After learning about how the IK solver works, I realised I’d have to create another ROS node, this time on the Linux PC connected to Baxter.</p>
<h4 id="Control-of-Baxter"><a href="#Control-of-Baxter" class="headerlink" title="Control of Baxter"></a>Control of Baxter</h4><p>Following some of the documentation on the Baxter site, I found an example which could be useful<br>There’s an example which can be run using:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ rosrun baxter_interface joint_trajectory_action_server</div><div class="line">$ rosrun baxter_examples joint_trajectory_client <span class="_">-l</span> left</div></pre></td></tr></table></figure></p>
<p>This moves Baxter’s left arm to three preset positions.</p>
<h4 id="IK-service"><a href="#IK-service" class="headerlink" title="IK service"></a>IK service</h4><p>Given a pose, this simply returns the planned path for the arm if a solution was found, it does not offer any control.<br>I can already subscribe to a pose topic from Unity.<br>The related example can be run like this:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ rosrun baxter_interface joint_trajectory_action_server</div><div class="line">$ rosrun baxter_examples ik_service_client.py <span class="_">-l</span> left</div></pre></td></tr></table></figure></p>
<p>This runs for a hard-coded preset point.</p>
<p>Initially I thought about mashing these two together, but there were a few problems.</p>
<ul>
<li>Collision would be ignored. This is risky</li>
<li>I have no easy way to debug, e.g. coordinate frame conversion errors</li>
</ul>
<h4 id="MoveIt"><a href="#MoveIt" class="headerlink" title="MoveIt"></a>MoveIt</h4><p>With some help from Rebecca, this solves some of those problems.</p>
<p>I wrote a python script which subscribes to two topics, <code>/vr/pose_l</code> and <code>/vr/pose_r</code>, both of which published by the VR PC.<br>On receiving a message, the IK service is called. It has a suitable planning time allowance, and final position error.<br>If a solution is found, the arm will move to that location.</p>
<p>The planned motion (and the subsequent motion) is shown in RViz.<br>Using RViz, I can also insert a primitive collision bound so that anywhere below table-height is off-limits.</p>
<figure class="highlight plain"><figcaption><span>baxter_table.scene</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">table</div><div class="line">* table</div><div class="line">1</div><div class="line">box</div><div class="line">3 3 0.05</div><div class="line">0 0 -0.2</div><div class="line">0 0 0 1</div><div class="line">0 0 0 0</div><div class="line">.</div><div class="line"></div><div class="line"># Scene name</div><div class="line"># Object name</div><div class="line"># Number of shapes</div><div class="line"># Shape type</div><div class="line"># Size</div><div class="line"># Position</div><div class="line"># Orientation</div><div class="line"># RGBA colour</div><div class="line"># Necessary</div></pre></td></tr></table></figure>
<p>Remember to run:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">source</span> ../moveit_ws/devel/setup.sh</div><div class="line">$ rosrun baxter_interface joint_trajectory_action_server</div><div class="line">$ roslaunch baxter_moveit_config baxter_grippers.launch</div><div class="line">$ python ~/path-to-script.py</div></pre></td></tr></table></figure></p>
<h4 id="Final-touches"><a href="#Final-touches" class="headerlink" title="Final touches"></a>Final touches</h4><ul>
<li>The script can be optimised, it contains a lot of extra information found for tutorial purposes.</li>
<li>I need feedback to Unity for when no solution could be found for a target position.</li>
<li>I need feedback to Unity for when a target position has been reached.</li>
<li>There are a few extra messages been published, such as messages which are all zero in initialisation. Iron out these.</li>
</ul>
<h4 id="Still-to-do"><a href="#Still-to-do" class="headerlink" title="Still to do!"></a>Still to do!</h4><p>‘Telepresence’ is nearly there. But it’s useless unless we can get data representing the real world in.<br>I’ll need to set up operating the grippers.<br>Once these are done I can begin the user tests.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/16/Pose-control-of-Baxter/" data-id="cj0bndpzp000x1k9re9adsid0" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Pose-message-from-Unity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/15/Pose-message-from-Unity/">Pose message from Unity</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/15/Pose-message-from-Unity/" class="article-date">
  <time datetime="2017-03-14T23:56:56.000Z" itemprop="datePublished">Wed 15/03/2017 00:56</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I open a new shared memory file for the poses to be sent out of Unity in a <code>geometry_msgs::Pose</code> message and subscribed to by Baxter.</p>
<p>The layout is as follows:</p>
<blockquote>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Length</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>4</td>
<td>Left Status bit (000X)</td>
<td>X set to 1 if something has been updated</td>
</tr>
<tr>
<td>4</td>
<td>4</td>
<td>Left Position X</td>
<td>-X from Unity</td>
</tr>
<tr>
<td>8</td>
<td>4</td>
<td>Left Position Y</td>
<td>Y from Unity</td>
</tr>
<tr>
<td>12</td>
<td>4</td>
<td>Left Position Z</td>
<td>Z from Unity</td>
</tr>
<tr>
<td>16</td>
<td>4</td>
<td>Left Orientation W</td>
<td>W from Unity</td>
</tr>
<tr>
<td>20</td>
<td>4</td>
<td>Left Orientation X</td>
<td>X from Unity</td>
</tr>
<tr>
<td>24</td>
<td>4</td>
<td>Left Orientation Y</td>
<td>-Y from Unity</td>
</tr>
<tr>
<td>28</td>
<td>4</td>
<td>Left Orientation Z</td>
<td>-Z from Unity</td>
</tr>
<tr>
<td>32</td>
<td>4</td>
<td>Right Status bit (000X)</td>
<td>Repeats, similar to the left side</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>64</td>
<td></td>
<td></td>
<td>[ended]</td>
</tr>
</tbody>
</table>
</blockquote>
<p>In order to get the rotation correct (Baxter is rotated -90_x from ROS coordinates to be upright in Unity), I created a dummy parent <code>GameObject</code> with the relevant transform to hold the tragets, and then just used <code>transform.localPosition</code> and <code>transform.localRotation</code>.<br>This accounts for the <em>user</em> being at the origin (which is how VR seems to operate) rather than Baxter being at the origin of his coordinate frame.</p>
<p>I’ll have to do the same for the target models as well.<br><img src="/Robotic-Telepresence/2017/03/15/Pose-message-from-Unity/Endpoint.png" alt="You can see it&#39;s 90 degrees out. Also the endpoint for the IK service is between the ends of the grippers, while Unity thinks it&#39;s the centroid(?)"></p>
<p>I have set it up so that any change to the number of targets in the queue will publish a message containing the pose of the frontmost (topmost) element.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/15/Pose-message-from-Unity/" data-id="cj0bndpzq000y1k9r01n9x7m8" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-CopyMemory-bug" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/15/CopyMemory-bug/">CopyMemory bug</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/15/CopyMemory-bug/" class="article-date">
  <time datetime="2017-03-14T23:30:28.000Z" itemprop="datePublished">Wed 15/03/2017 00:30</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I had a bug for many many hours, took me a while to narrow down.<br>I verified that everything worked perfectly at home.<br>However, in the lab, there was some strange behaviour with the shared memory for the hand poses.<br><code>CopyMemory</code> is defined on <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366535" target="_blank" rel="external">MSDN</a> like this:<br><figure class="highlight cpp"><figcaption><span>CopyMemory definition</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CopyMemory</span><span class="params">(</span></span></div><div class="line">  _In_       PVOID  Destination,</div><div class="line">  _In_ <span class="keyword">const</span> VOID   *Source,</div><div class="line">  _In_       SIZE_T Length</div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>I encapsulated the memory functions in a class for my ROS node.<br><figure class="highlight cpp"><figcaption><span>Single byte reading function</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">uint8_t</span> FileMapping::read_data(<span class="keyword">int</span> offset) &#123;</div><div class="line">	CopyMemory(data, buffer+offset, <span class="number">1</span>);</div><div class="line">	<span class="keyword">return</span> data[<span class="number">0</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>However, to get things to work correctly in the lab, I had to half the offset parameter.<br><figure class="highlight cpp"><figcaption><span>Modified line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CopyMemory(data, buffer+(offset/<span class="number">2</span>), <span class="number">1</span>);</div></pre></td></tr></table></figure></p>
<p>This problem also occurs in a <code>float FileMapping::read_data_float(int offset)</code> function.<br>I’ve been careful to use <code>sizeof(float)</code> etc. and not assume sizes of things (although I have checked, and it is defined as 4 bytes everywhere).</p>
<p>This fix works so I’ll leave it as this, and this is the first place to look when the problem surfaces again.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/15/CopyMemory-bug/" data-id="cj0bndpxx00081k9rk5wd7pf9" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Live-joint-data" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/08/Live-joint-data/">Live joint data</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/08/Live-joint-data/" class="article-date">
  <time datetime="2017-03-08T10:51:47.000Z" itemprop="datePublished">Wed 08/03/2017 10:51</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I ran the new code and project in the robot lab.<br>I appears that the jerky motion exhibited by the <code>rosbag</code> was related to the recording.<br>The computer running <code>roscore</code> connected to baxter is not connected directly to the Unity PC, but they are in the same network.<br>As there are no problems detected so far, the URDF data contained in Baxter matches the URDF file in the Unity project.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/IKGjTFgAbt4" frameborder="0" allowfullscreen></iframe></div>
<p>I got the ROSnode application to open with Unity, and close when the editor is stopped.<br>There isn’t any kind of message to say when it’s ready. If it’s not ready, the shared memory is mapped after a couple of failed attempts, but a 500ms delay has been added to make sure it connects first time.</p>
<p>Initiallly I made it so a window doesn’t open at all, now it seems like internal process.<br>Any output is printed to the Unity Editor log. It’s redirected so if the window was visible there wouldn’t be anything printed anyway.<br>It’s also colour coded so it’s easy to see where messages are coming from.<br>However, when doing this, the serial client loses synchronisation after around 20 seconds for some reason.<br>I suspect it’s to do with an issue redirecting standard output and error, I didn’t get a problem when running it as before.<br>Disabling this functionality for now.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/08/Live-joint-data/" data-id="cj0bndpye000m1k9r9kpk8hmn" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Memory-Structure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/02/Memory-Structure/">Memory structure</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/02/Memory-Structure/" class="article-date">
  <time datetime="2017-03-02T22:47:09.000Z" itemprop="datePublished">Thu 02/03/2017 22:47</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Baxter’s-Hands"><a href="#Baxter’s-Hands" class="headerlink" title="Baxter’s Hands"></a>Baxter’s Hands</h4><p>On examining the <code>URDF</code>, the different type of movement the hands have is called <code>prismatic</code>, as opposed to <code>revolute</code> for all other movable joints.<br>I’ve addded the functionality to read the messages from a topic. The rosbag only publishes one gripper for each hand, because the <code>urdf</code> talles the other to “mimic” the other one but with mirrored motion.<br>While trying to get this to work, I decided the structure of the shared memory needed to be improved.</p>
<h4 id="Proposed-structure"><a href="#Proposed-structure" class="headerlink" title="Proposed structure"></a>Proposed structure</h4><blockquote>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Length</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>How many joints <code>n</code></td>
<td>Static</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>Joint name length <code>l</code></td>
<td>Static. Goes down hierarchy, then alphabetically</td>
</tr>
<tr>
<td>2</td>
<td><code>l</code></td>
<td>Joint name</td>
<td>Mirrors joint name order</td>
</tr>
<tr>
<td></td>
<td></td>
<td><em>(other joint names, lengths)</em></td>
<td></td>
</tr>
<tr>
<td><code>n*(l+1)</code></td>
<td>4</td>
<td>Joint position</td>
<td>double in msg, truncated to float, as 4 bytes</td>
</tr>
<tr>
<td></td>
<td></td>
<td><em>(other joint positions)</em></td>
<td></td>
</tr>
<tr>
<td><code>n*(l+5)</code></td>
<td>-</td>
<td>End of data</td>
</tr>
</tbody>
</table>
</blockquote>
<p>The Unity project SHOULD! be able to dynamically associate the related <code>GameObjects</code>, as the names should match perfectly.<br>It could then notify the developer of any conflicts.</p>
<h4 id="NEW-proposed-structure"><a href="#NEW-proposed-structure" class="headerlink" title="NEW proposed structure"></a>NEW proposed structure</h4><p>I realised that as you won’t know the names in advance, each one will be added to a list (vector <span class="github-emoji" title=":wink:" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f609.png?v7">&#x1f609;</span>) of known joints as they come in.<br>This means the offsets can’t be set on startup.<br>I’ll probably have to create objects in a vector for each joint:</p>
<blockquote>
<ul>
<li>Vector<object type=""><ul>
<li><strong>Joint object</strong></li>
<li>Name</li>
<li>Offset of position</li>
</ul>
</object></li>
</ul>
</blockquote>
<p>Each message will have to be compared to the list of objects, but the data for that comes in every message anyway so the bottleneck should still be in the receiving of messages.</p>
<blockquote>
<table>
<thead>
<tr>
<th>Joint number <code>n</code></th>
<th>Offset</th>
<th>Length</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>-</td>
<td>0</td>
<td>1</td>
<td>Number of joints</td>
<td>Will increase as more are added</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>4</td>
<td>Joint position</td>
<td>Joint name to follow</td>
</tr>
<tr>
<td></td>
<td>5</td>
<td>1</td>
<td>Joint name length <code>l</code></td>
<td>Need to know this to read the name</td>
</tr>
<tr>
<td></td>
<td>6</td>
<td><code>l</code></td>
<td>Joint name</td>
<td>We know how many to read</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>1+<code>5n</code>+<code>l</code></td>
<td></td>
<td>Joint position</td>
<td>etc.</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<p>After some head scratching (for a few days), I managed to get it working.<br>It showed me that my combined URDF was incorrect; I had replaced <code>${side}</code> with “right” and “left”, and it should have been “r” and “l”.<br><img src="/Robotic-Telepresence/2017/03/02/Memory-Structure/Dynamic Objects.png" alt="This list is empty before running"></p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/02/Memory-Structure/" data-id="cj0bndpyf000n1k9rxezt9o7w" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Main-control-loop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/02/Main-control-loop/">Main control loop</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/02/Main-control-loop/" class="article-date">
  <time datetime="2017-03-02T21:37:29.000Z" itemprop="datePublished">Thu 02/03/2017 21:37</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Current-objective"><a href="#Current-objective" class="headerlink" title="Current objective"></a>Current objective</h4><p>I really need to get the main control loop sorted. Each part has been demonstrated to work separately, but it needs to work all together.<br>I need to get joint angles from the robot (using a <code>rosbag</code> for now), which are published on a linux machine running <code>roscore</code>.<br>These need to be subscribed to from a Windows machine, and the data should be put into shared memory.<br>This data needs to be read by Unity in and each corresponding joint should be rotated in real time to mirror the robot.</p>
<p>I then also need to be able to set target positions and poses for the hands using the tracked Vive controllers in VR.<br>These targets need to be put back into some shared memory, which is read by the console application and published back to ROS.</p>
<h4 id="After-that"><a href="#After-that" class="headerlink" title="After that"></a>After that</h4><p>I still need to know how to tell Baxter to move, I aim to do that this week.<br>I also need to implement bounds, for target positions. I can do that at home.<br>Now that the grippers are in the model, I can implement messages for those too (but they don’t move in the <code>rosbag</code>)<br>I suppose I can call the executable directly from Unity, making it more seamless. Not a priority but might be useful.</p>
<h4 id="On-the-back-burner"><a href="#On-the-back-burner" class="headerlink" title="On the back burner"></a>On the back burner</h4><p>Point clouds, grr.<br>It will (should…) be much easier to transmit a depth image over the network, so if I can work out how to convert that into a surfacein Unity, I might be able to implement functionality for the kinect, whether it’s plugged into the Windows or ROS Linux machine.<br>This isn’t taking priority right now though.</p>
<h4 id="Development-work"><a href="#Development-work" class="headerlink" title="Development work"></a>Development work</h4><p>I had to reinstall my virtual machine as the virtual hard disk got corrupted. Probably because I previously ran it on a RAMdisk and had to copy it over each time.<br>This was not particularly useful or sensible, and should be fine on a SATA SSD.<br>I had to redownload the <code>rosbag</code> we recorded before. This time it would sit in a shared folder on the host machine, not inside the virtual hard disk.<br>To save time I used the compressed version which I didn’t notice a problem with before (1.38GB as oppposed to 7.95GB).<br>This time, the compressed bag playback halts as soon as something tries to subscribe to a topic, even when locally running <code>rostopic echo /robot/joint_states --noarr --nostr</code>.<br>The uncompressed one plays fine.</p>
<p>I have a lot of code files and scripts floating around in various projects and folders, so it was not straight forward to remember which ones had the working code in.<br>It took around 4 hours, but I was eventually able to get everything working for data getting from ROS to Unity<br><img src="/Robotic-Telepresence/2017/03/02/Main-control-loop/Waving.png" alt="Baxter is waving as in the video in &lt;a href=/Robotic-Telepresence/2016/11/28/Rosbag-communication&gt;this post&lt;/a&gt;, but this time using lovely OOP using shared memory, rather than janky code with pipes"></p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/02/Main-control-loop/" data-id="cj0bndpyd000l1k9ry99033hc" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Project-meeting-12" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/02/Project-meeting-12/">Project meeting 12</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/02/Project-meeting-12/" class="article-date">
  <time datetime="2017-03-02T10:47:16.000Z" itemprop="datePublished">Thu 02/03/2017 10:47</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>The development and issues with point clouds were discussed.<br>It may be possible to transmit a depth image over ROS rather than a point cloud.<br>If I can get the live depth image into a point cloud on the Unity client, I may be able to swap in the ROS message.</p>
<p>However, the focus now is on getting the simple control and feedback finished, so I will be forgetting abou point clouds for now.<br>I hope to have this part near complete over this week.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/02/Project-meeting-12/" data-id="cj0bndpzx00121k9rqbmxja2h" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Fixing-point-cloud-problems" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/02/28/Fixing-point-cloud-problems/">Fixing point cloud problems</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/02/28/Fixing-point-cloud-problems/" class="article-date">
  <time datetime="2017-02-28T22:50:35.000Z" itemprop="datePublished">Tue 28/02/2017 22:50</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>Now that the lab computer has access to the network, it was possible to attempt to communicate with the ROS machine.<br>After sorting out an issue caused by Windows Firewall, it was possible to receive joint messages over <code>rosserial_server socket_node</code>.<br>However, a single <code>PointCloud2</code> message caused CPU to skip to (over) 100%, and the serial server to hang, just as for me.<br>Oscar found a python script which would publish a custom point cloud and regularly send the message, containing just 3 white points.<br>This was able to be received!<br>It’s time to verify whether the problem was caused by the point clouds being too big, or if it was something like the colour interfering with the expected message format.</p>
<p>New test field format</p>
<blockquote>
<table>
<thead>
<tr>
<th>0-4</th>
<th>5-8</th>
<th>7-11</th>
</tr>
</thead>
<tbody>
<tr>
<td>X</td>
<td>Y</td>
<td>Z</td>
</tr>
</tbody>
</table>
</blockquote>
<p>Old real field format</p>
<blockquote>
<table>
<thead>
<tr>
<th>0-4</th>
<th>5-8</th>
<th>7-11</th>
<th>12-15</th>
<th>16-19</th>
<th>20-23</th>
<th>24-27</th>
<th>28-31</th>
</tr>
</thead>
<tbody>
<tr>
<td>X</td>
<td>Y</td>
<td>Z</td>
<td>–</td>
<td>C</td>
<td>–</td>
<td>–</td>
<td>–</td>
</tr>
</tbody>
</table>
</blockquote>
<p>The python script is only able to publish point clouds in the first format.<br>I had to reverse engineer the python file using functionality in:<br><code>/opt/ros/indigo/lib/python2.7/dist-packages/sensor_msgs/point_cloud2.py</code><br>It should match the format of the existing clouds from the Kinect wth Baxter.</p>
<p>I was able to receive three points in the new format.</p>
<p>Since the real point cloud data is in the byte format, I’ll use random Matlab data to test.<br><figure class="highlight matlab"><figcaption><span>Matlab workspace</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data = <span class="built_in">randn</span>(<span class="built_in">length</span>,<span class="number">8</span>);</div><div class="line">csvwrite(<span class="string">'out.csv'</span>, data)</div></pre></td></tr></table></figure></p>
<p>I then pasted the (formatted) values directly into the python file.</p>
<p>I found some weird problems. Looking into it:<br><code>msg.data_length</code> is:</p>
<ul>
<li>32 for 1 point (expected)</li>
<li>64 for 2 points (expected)</li>
<li>128 for 4 points (expected)</li>
<li>ACCESS VIOLATION at 8 points when attempting to read <code>msg.data[0]</code></li>
<li>224 for 7 points (expected)</li>
<li>32 for 9 points</li>
<li>Nothing received for many (&gt;100 points)<ul>
<li>These can still be listened to locally with <code>rostopic echo &lt;path&gt;</code></li>
<li>Everything is still responsive</li>
</ul>
</li>
</ul>
<p>On closer inspection, it seems like there is some kind of quantisation going on.<br>16 points gives the same error as for 8 points, and 9 points looks like 1 point.<br>Not quite sure why yet.<br>The python script makes <code>height = 1</code>, and <code>width = data length</code>.</p>
<p>I tried changing the buffer sizes in the generated C++ files on the Windows PC:<br><figure class="highlight cpp"><figcaption><span>ros_lib/ros/node_handle.h excerpt</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">namespace</span> ros &#123;</div><div class="line">  <span class="keyword">using</span> rosserial_msgs::TopicInfo;</div><div class="line">  <span class="comment">/* Node Handle */</span></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keyword">class</span> Hardware,</div><div class="line">           <span class="keyword">int</span> MAX_SUBSCRIBERS=<span class="number">25</span>, <span class="comment">// Reduced from 25</span></div><div class="line">           <span class="keyword">int</span> MAX_PUBLISHERS=<span class="number">25</span>, <span class="comment">// Reduced from 25</span></div><div class="line">           <span class="keyword">int</span> INPUT_SIZE=<span class="number">200000</span>, <span class="comment">// Increased from 512</span></div><div class="line">           <span class="keyword">int</span> OUTPUT_SIZE=<span class="number">200000</span>&gt; <span class="comment">// Increased from 512</span></div><div class="line">  <span class="keyword">class</span> NodeHandle_ : <span class="keyword">public</span> NodeHandleBase_</div><div class="line">  &#123;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>This resulted in me being able to see large (1x640) messages!<br>However, the length is still zero with no data being transmitted.<br>By reducing the actual length by 1, so making it 1x639, the message was reported to have length of 224.<br>Not sure where this is being limited, but I’ll try the real point cloud from the <code>rosbag</code>.<br>The same thing happens as before.</p>
<p>Reverting back to the example point cloud, made up of just [X, Y, Z], the limit seems to be <code>256</code> bytes.<br>as <code>22</code> points gives a <code>data_length</code> of <code>252</code> (4<em>3</em>22), but <code>23</code> points gives a length of <code>8</code> bytes.</p>
<p>Can read exactly 367 times more memory in <code>data[]</code> than I thought I could? (32 bytes, proper point cloud)<br>3056 times with simple point cloud</p>
<p>Windows application seems to make a buffer of arbitrary size, we should read until <code>data_length</code> even though the array doesn’t end there.<br>Adapted python program to only print one point cloud and then quit.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/02/28/Fixing-point-cloud-problems/" data-id="cj0bndpy3000c1k9rl1v2h1mm" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/Robotic-Telepresence/page/2/">2</a><a class="page-number" href="/Robotic-Telepresence/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/Robotic-Telepresence/page/8/">8</a><a class="extend next" rel="next" href="/Robotic-Telepresence/page/2/">Next &raquo;</a>
  </nav>

</section>
        <!-- MANUALLY ADDED FOR GANTT CHART -->
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/03/">March 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/02/">February 2017</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/12/">December 2016</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/11/">November 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/10/">October 2016</a><span class="archive-list-count">14</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Celyn Walters<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/Robotic-Telepresence/" class="mobile-nav-link">Home</a>
  
    <a href="/Robotic-Telepresence/Project-objectives" class="mobile-nav-link">Project Objectives</a>
  
    <a href="https://www.teamgantt.com/gantt/schedule/?ids=702976&public_keys=1UNWW0SIdEwg&zoom=w90&font_size=12&estimated_hours=0&assigned_resources=0&percent_complete=0&documents=0&comments=0&col_width=255&menu_view=0&resource_filter=1&name_in_bar=0&name_next_to_bar=0&resource_names=1" class="mobile-nav-link">Gantt Chart</a>
  
    <a href="/Robotic-Telepresence/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/Robotic-Telepresence/fancybox/jquery.fancybox.css">
  <script src="/Robotic-Telepresence/fancybox/jquery.fancybox.pack.js"></script>


<script src="/Robotic-Telepresence/js/script.js"></script>

  </div>
</body>
</html>
