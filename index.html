<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Robotic Telepresence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Robotic Telepresence">
<meta property="og:url" content="https://celynwalters.github.io/Robotic-Telepresence/index.html">
<meta property="og:site_name" content="Robotic Telepresence">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Robotic Telepresence">
  
    <link rel="alternate" href="/atom.xml" title="Robotic Telepresence" type="application/atom+xml">
  
  
    <link rel="icon" href="/Robotic-Telepresence/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/Robotic-Telepresence/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-87037949-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/Robotic-Telepresence/" id="logo">Robotic Telepresence</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/Robotic-Telepresence/" id="subtitle">Electronic Engineering BEng final project</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/">Home</a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/Project-objectives">Project Objectives</a>
        
          <a class="main-nav-link" href="https://www.teamgantt.com/gantt/schedule/?ids=702976&public_keys=1UNWW0SIdEwg&zoom=w90&font_size=12&estimated_hours=0&assigned_resources=0&percent_complete=0&documents=0&comments=0&col_width=255&menu_view=0&resource_filter=1&name_in_bar=0&name_next_to_bar=0&resource_names=1">Gantt Chart</a>
        
          <a class="main-nav-link" href="/Robotic-Telepresence/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://celynwalters.github.io/Robotic-Telepresence"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Examining-octomap-messages" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/17/Examining-octomap-messages/">Extending rosserial size</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/17/Examining-octomap-messages/" class="article-date">
  <time datetime="2017-03-17T11:05:47.000Z" itemprop="datePublished">Fri 17/03/2017 12:05</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>The <code>rosbag</code> I have access to contains octomap messages.<br>Using <code>rosbag info</code>, it has 55 messages. Echoing the first one shows it contains 83860 bytes.<br>The maximum I’ve been able to get using <code>rosserial</code> is 1177, although I’d expect it to be 65536.</p>
<p>Managed to get it up to 2221 points by increasing <code>INPUT_SIZE</code> and <code>OUTPUT_SIZE</code> from 512 to 1024<br>(Repeatable):<br>1776 using 512<br>    3.46875<br>2221 using 1024<br>    2.1689453125<br>4065 using 2048<br>    1.98486328125<br>        31<br>65468 using 65536<br>    0.99896240234375<br>        68</p>
<p>Need 9830400 every 0.1 seconds…<br>1500 Hz at this throughput!</p>
<p>An interesting development.<br>When publishing only just over the maximum buffer, <code>rosserial_server</code> exits without hanging:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">terminate called after throwing an instance of <span class="string">'ros::serialization::StreamOverrunException'</span></div><div class="line">  what():  Buffer Overrun</div><div class="line">Aborted (core dumped)</div></pre></td></tr></table></figure></p>
<p>This time, the limit is ROS in linux.<br>It’s not a compatibility issue between different versions of <code>rosserial_server</code> and <code>rosserial_windows</code> (tested it).</p>
<figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p ~/catkin_ws/src</div><div class="line">$ <span class="built_in">cd</span> !$</div><div class="line">$ catkin_init_workspace</div><div class="line">$ <span class="built_in">cd</span> src/</div><div class="line">$ git <span class="built_in">clone</span> -b indigo-devel https://github.com/ros-drivers/rosserial.git</div><div class="line">$ <span class="built_in">cd</span> ../</div><div class="line">$ catkin_make</div></pre></td></tr></table></figure>
<p>Sending 1000x largest clouds at 100Hz.<br><code>rostopic echo</code> is as expected, takes 10 seconds.<br>Windows subscriber stops at 751, takes<br>    7.499 to 37.415 = 29.916 seconds<br>    3.666 to 32.948 = 29.282</p>
<p>Decreasing wait in spin() loop to 1ms from 5ms<br>Did 852 this time!<br>    3.733 to 30.648 = 26.915 seconds</p>
<p>Switching to Release in Visual Stuio causes <code>rosserial_server</code> to complain:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[ERROR] [1489763341.521603888]: Buffer overrun when attempting to parse setup message.</div><div class="line">[ERROR] [1489763341.521666993]: Is this firmware from a pre-Groovy rosserial?</div><div class="line">[ERROR] [1489763341.521753826]: Buffer overrun when attempting to parse setup message.</div></pre></td></tr></table></figure></p>
<p>95.63% of the CPU used was in <code>WindowsSocket::read</code>.</p>
<p>Multi-threaded spinning?! Yes please.<br><a href="http://wiki.ros.org/roscpp/Overview/Callbacks%20and%20Spinning#Multi-threaded_Spinning" target="_blank" rel="external">http://wiki.ros.org/roscpp/Overview/Callbacks%20and%20Spinning#Multi-threaded_Spinning</a></p>
<p>It’s not a part of <code>rosserial_windows</code>…<br>There’s a <code>roscpp</code> folder but there’s not much in there.</p>
<p>Mashed!</p>
<ul>
<li><a href="https://github.com/ros/ros_comm" target="_blank" rel="external">https://github.com/ros/ros_comm</a></li>
<li><a href="https://github.com/ros/roscpp_core" target="_blank" rel="external">https://github.com/ros/roscpp_core</a></li>
</ul>
<p>WallTime and WallDuration replace with Time and Duration respectively.<br>Build succeeded! WOW.<br>No. No.</p>
<p>16th of optimised point cloud = 19200<br>25.5Hz at max data size (65468), limited by CPU though (single core).<br>87Hz max like this (my CPU). Ok.</p>
<p><a href="https://www.phoronix.com/scan.php?page=article&amp;item=steamvr-linux-beta&amp;num=4" target="_blank" rel="external">https://www.phoronix.com/scan.php?page=article&amp;item=steamvr-linux-beta&amp;num=4</a></p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/17/Examining-octomap-messages/" data-id="cj0i5jeam000ays9ra1gx70wg" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Extending-rosserial-size" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/17/Extending-rosserial-size/">Extending rosserial size</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/17/Extending-rosserial-size/" class="article-date">
  <time datetime="2017-03-17T11:05:47.000Z" itemprop="datePublished">Fri 17/03/2017 12:05</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h2 id="Mega-draft-notes-for-me"><a href="#Mega-draft-notes-for-me" class="headerlink" title="Mega draft notes for me"></a>Mega draft notes for me</h2><p>Managed to get it up to 2221 points by increasing <code>INPUT_SIZE</code> and <code>OUTPUT_SIZE</code> from 512 to 1024<br>(Repeatable):<br>1776 using 512<br>    3.46875<br>2221 using 1024<br>    2.1689453125<br>4065 using 2048<br>    1.98486328125<br>        31<br>65468 using 65536<br>    0.99896240234375<br>        68</p>
<p>Need 9830400 every 0.1 seconds…<br>1500 Hz at this throughput!</p>
<p>An interesting development.<br>When publishing only just over the maximum buffer, <code>rosserial_server</code> exits without hanging:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">terminate called after throwing an instance of <span class="string">'ros::serialization::StreamOverrunException'</span></div><div class="line">  what():  Buffer Overrun</div><div class="line">Aborted (core dumped)</div></pre></td></tr></table></figure></p>
<p>This time, the limit is ROS in linux.<br>It’s not a compatibility issue between different versions of <code>rosserial_server</code> and <code>rosserial_windows</code> (tested it).</p>
<figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p ~/catkin_ws/src</div><div class="line">$ <span class="built_in">cd</span> !$</div><div class="line">$ catkin_init_workspace</div><div class="line">$ <span class="built_in">cd</span> src/</div><div class="line">$ git <span class="built_in">clone</span> -b indigo-devel https://github.com/ros-drivers/rosserial.git</div><div class="line">$ <span class="built_in">cd</span> ../</div><div class="line">$ catkin_make</div></pre></td></tr></table></figure>
<p>Sending 1000x largest clouds at 100Hz.<br><code>rostopic echo</code> is as expected, takes 10 seconds.<br>Windows subscriber stops at 751, takes<br>    7.499 to 37.415 = 29.916 seconds<br>    3.666 to 32.948 = 29.282</p>
<p>Decreasing wait in spin() loop to 1ms from 5ms<br>Did 852 this time!<br>    3.733 to 30.648 = 26.915 seconds</p>
<p>Switching to Release in Visual Stuio causes <code>rosserial_server</code> to complain:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[ERROR] [1489763341.521603888]: Buffer overrun when attempting to parse setup message.</div><div class="line">[ERROR] [1489763341.521666993]: Is this firmware from a pre-Groovy rosserial?</div><div class="line">[ERROR] [1489763341.521753826]: Buffer overrun when attempting to parse setup message.</div></pre></td></tr></table></figure></p>
<p>95.63% of the CPU used was in <code>WindowsSocket::read</code>.</p>
<p>Multi-threaded spinning?! Yes please.<br>It’s not a part of <code>rosserial_windows</code>…<br>There’s a <code>roscpp</code> folder but there’s not much in there.<br><a href="http://wiki.ros.org/roscpp/Overview/Callbacks%20and%20Spinning#Multi-threaded_Spinning" target="_blank" rel="external">http://wiki.ros.org/roscpp/Overview/Callbacks%20and%20Spinning#Multi-threaded_Spinning</a></p>
<p>16th of optimised point cloud = 19200<br>25.5Hz at max data size (65468), limited by CPU though (single core).<br>87Hz max like this (my CPU). Ok.</p>
<p><a href="https://www.phoronix.com/scan.php?page=article&amp;item=steamvr-linux-beta&amp;num=4" target="_blank" rel="external">https://www.phoronix.com/scan.php?page=article&amp;item=steamvr-linux-beta&amp;num=4</a></p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/17/Extending-rosserial-size/" data-id="cj0i5jeao000bys9rcgbt1neu" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Point-cloud-problem-identified" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/16/Point-cloud-problem-identified/">Point cloud problem identified</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/16/Point-cloud-problem-identified/" class="article-date">
  <time datetime="2017-03-16T18:19:24.000Z" itemprop="datePublished">Thu 16/03/2017 19:19</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>As suspected, it wasn’t the python script which was limiting the data to 8 points.<br>Something I couldn’t check with the rosbag: running <code>rostopic echo /camera/depth_registered/points</code> gives an accurate response.</p>
<p>When using normal clouds:</p>
<ul>
<li>Described as {X, Y, Z}</li>
<li>12 bytes long (4 bytes for each axis)</li>
<li>A 21 point message reports a length of 252 (as expected)</li>
<li>A 22 point message reports a length of 8 (264 expected)</li>
</ul>
<p>When using the point cloud type I need:</p>
<ul>
<li>Described as {X, Y, Z, _, C, _, _, _}</li>
<li>32 bytes long</li>
<li>A 1 point message reports a length of 32 (as expected)</li>
<li>A 7 point message reports a length of 224 (as expected)</li>
<li>An 8 point message reports a length of 0 (256 expected)</li>
</ul>
<p>It’s not the python script. It’s the serial communication.</p>
<p>With some further investigation:<br><code>msg.data_length</code> is a <code>uint8_t</code>, which is the same length as a <code>char</code> and has a maximum of 255.<br>This is because <code>rosserial</code> was written with Arduino-like embedded devices in mind, which have much tighter hardware limitations than traditional PCs.<br>The modifications to ROS to allow for greater sizes for things such as point cloud, images etc. has been implemented for <code>Kinetic Kame</code> and the development branch of <code>Jade Turtle</code>.<br>The <code>msg.data_length</code> is now a <code>uint32_t</code>.<br>Somebody had success patching Indigo and building the source, I don’t think I have this choice.</p>
<p>My options:</p>
<ul>
<li>Try to split the point cloud into chunks<br>This “<a href="https://github.com/ros-drivers/rosserial/issues/130#issuecomment-52449568" target="_blank" rel="external">sounds like a huge pain in the butt</a>“.</li>
<li>Use <code>roscpp/winros</code> rather than <code>rosserial</code>.<br>It could be too late in the process to make the move.<br>Also I’ve heard it’s not very stable or reliable.<br>However <a href="https://github.com/ros-drivers/rosserial/issues/130#issuecomment-52449568" target="_blank" rel="external">this post</a> mentions that Hydro (before Indigo, the release we’re using) it was very usable back in 2014.</li>
<li>Generate <code>rosserial_windows</code> libraries from Jade</li>
<li>Try to transmit much less data.<br>Just sending locations of objects and rendering them in Unity3D. Discussed in the <a href="here">previous project meeting</a></li>
</ul>
<p>Here are some more people with this problem</p>
<ul>
<li><a href="https://stackoverflow.com/questions/40813625/rosserial-publish-sensor-msgs-image-from-windows" target="_blank" rel="external">Recent</a></li>
<li><a href="http://answers.ros.org/question/189571/array-size-limited-to-255-in-rosserial/" target="_blank" rel="external">Same date as Github issues linked above, no answers</a></li>
</ul>
<h4 id="Kinetic-rosserial-windows"><a href="#Kinetic-rosserial-windows" class="headerlink" title="Kinetic rosserial_windows"></a>Kinetic <code>rosserial_windows</code></h4><p>I set up a new virtual machine to install a fresh copy of <code>Kinetic Kame</code> to generate new <code>rosserial_windows</code> source.<br>This seems to run with no issue, even when the host <code>rosserial_server</code> is running <code>Indigo</code> (2 versions behind).<br>I modified the point cloud python script to use a single-byte point field to see exactly how much could be received.<br>Now I can send much more than 256 bytes… but there seems to be a hard limit of 1177 bytes, this would allow 36 full points…<br>Not nearly enough. Shouldn’t I be getting up to 65536 bytes (2048 points)??</p>
<p>I even tried using the <code>Kinetic</code> environment as a host. I get the same problem, and the stability seems much worse!</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/16/Point-cloud-problem-identified/" data-id="cj0i5jec9000wys9r83jm8i0s" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Pose-control-of-Baxter" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/16/Pose-control-of-Baxter/">Pose control of Baxter</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/16/Pose-control-of-Baxter/" class="article-date">
  <time datetime="2017-03-15T23:33:43.000Z" itemprop="datePublished">Thu 16/03/2017 00:33</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>After learning about how the IK solver works, I realised I’d have to create another ROS node, this time on the Linux PC connected to Baxter.</p>
<h4 id="Control-of-Baxter"><a href="#Control-of-Baxter" class="headerlink" title="Control of Baxter"></a>Control of Baxter</h4><p>Following some of the documentation on the Baxter site, I found an example which could be useful<br>There’s an example which can be run using:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ rosrun baxter_interface joint_trajectory_action_server</div><div class="line">$ rosrun baxter_examples joint_trajectory_client <span class="_">-l</span> left</div></pre></td></tr></table></figure></p>
<p>This moves Baxter’s left arm to three preset positions.</p>
<h4 id="IK-service"><a href="#IK-service" class="headerlink" title="IK service"></a>IK service</h4><p>Given a pose, this simply returns the planned path for the arm if a solution was found, it does not offer any control.<br>I can already subscribe to a pose topic from Unity.<br>The related example can be run like this:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ rosrun baxter_interface joint_trajectory_action_server</div><div class="line">$ rosrun baxter_examples ik_service_client.py <span class="_">-l</span> left</div></pre></td></tr></table></figure></p>
<p>This runs for a hard-coded preset point.</p>
<p>Initially I thought about mashing these two together, but there were a few problems.</p>
<ul>
<li>Collision would be ignored. This is risky</li>
<li>I have no easy way to debug, e.g. coordinate frame conversion errors</li>
</ul>
<h4 id="MoveIt"><a href="#MoveIt" class="headerlink" title="MoveIt"></a>MoveIt</h4><p>With some help from Rebecca, this solves some of those problems.</p>
<p>I wrote a python script which subscribes to two topics, <code>/vr/pose_l</code> and <code>/vr/pose_r</code>, both of which published by the VR PC.<br>On receiving a message, the IK service is called. It has a suitable planning time allowance, and final position error.<br>If a solution is found, the arm will move to that location.</p>
<p>The planned motion (and the subsequent motion) is shown in RViz.<br>Using RViz, I can also insert a primitive collision bound so that anywhere below table-height is off-limits.</p>
<figure class="highlight plain"><figcaption><span>baxter_table.scene</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">table</div><div class="line">* table</div><div class="line">1</div><div class="line">box</div><div class="line">3 3 0.05</div><div class="line">0 0 -0.2</div><div class="line">0 0 0 1</div><div class="line">0 0 0 0</div><div class="line">.</div><div class="line"></div><div class="line"># Scene name</div><div class="line"># Object name</div><div class="line"># Number of shapes</div><div class="line"># Shape type</div><div class="line"># Size</div><div class="line"># Position</div><div class="line"># Orientation</div><div class="line"># RGBA colour</div><div class="line"># Necessary</div></pre></td></tr></table></figure>
<p>Remember to run:<br><figure class="highlight bash"><figcaption><span>Command line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">source</span> ../moveit_ws/devel/setup.sh</div><div class="line">$ rosrun baxter_interface joint_trajectory_action_server</div><div class="line">$ roslaunch baxter_moveit_config baxter_grippers.launch</div><div class="line">$ python ~/path-to-script.py</div></pre></td></tr></table></figure></p>
<h4 id="Final-touches"><a href="#Final-touches" class="headerlink" title="Final touches"></a>Final touches</h4><ul>
<li>The script can be optimised, it contains a lot of extra information found for tutorial purposes.</li>
<li>I need feedback to Unity for when no solution could be found for a target position.</li>
<li>I need feedback to Unity for when a target position has been reached.</li>
<li>There are a few extra messages been published, such as messages which are all zero in initialisation. Iron out these.</li>
</ul>
<h4 id="Still-to-do"><a href="#Still-to-do" class="headerlink" title="Still to do!"></a>Still to do!</h4><p>‘Telepresence’ is nearly there. But it’s useless unless we can get data representing the real world in.<br>I’ll need to set up operating the grippers.<br>Once these are done I can begin the user tests.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/16/Pose-control-of-Baxter/" data-id="cj0i5jecb000zys9r6m6f7pgg" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Pose-message-from-Unity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/15/Pose-message-from-Unity/">Pose message from Unity</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/15/Pose-message-from-Unity/" class="article-date">
  <time datetime="2017-03-14T23:56:56.000Z" itemprop="datePublished">Wed 15/03/2017 00:56</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I open a new shared memory file for the poses to be sent out of Unity in a <code>geometry_msgs::Pose</code> message and subscribed to by Baxter.</p>
<p>The layout is as follows:</p>
<blockquote>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Length</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>4</td>
<td>Left Status bit (000X)</td>
<td>X set to 1 if something has been updated</td>
</tr>
<tr>
<td>4</td>
<td>4</td>
<td>Left Position X</td>
<td>-X from Unity</td>
</tr>
<tr>
<td>8</td>
<td>4</td>
<td>Left Position Y</td>
<td>Y from Unity</td>
</tr>
<tr>
<td>12</td>
<td>4</td>
<td>Left Position Z</td>
<td>Z from Unity</td>
</tr>
<tr>
<td>16</td>
<td>4</td>
<td>Left Orientation W</td>
<td>W from Unity</td>
</tr>
<tr>
<td>20</td>
<td>4</td>
<td>Left Orientation X</td>
<td>X from Unity</td>
</tr>
<tr>
<td>24</td>
<td>4</td>
<td>Left Orientation Y</td>
<td>-Y from Unity</td>
</tr>
<tr>
<td>28</td>
<td>4</td>
<td>Left Orientation Z</td>
<td>-Z from Unity</td>
</tr>
<tr>
<td>32</td>
<td>4</td>
<td>Right Status bit (000X)</td>
<td>Repeats, similar to the left side</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>64</td>
<td></td>
<td></td>
<td>[ended]</td>
</tr>
</tbody>
</table>
</blockquote>
<p>In order to get the rotation correct (Baxter is rotated -90_x from ROS coordinates to be upright in Unity), I created a dummy parent <code>GameObject</code> with the relevant transform to hold the tragets, and then just used <code>transform.localPosition</code> and <code>transform.localRotation</code>.<br>This accounts for the <em>user</em> being at the origin (which is how VR seems to operate) rather than Baxter being at the origin of his coordinate frame.</p>
<p>I’ll have to do the same for the target models as well.<br><img src="/Robotic-Telepresence/2017/03/15/Pose-message-from-Unity/Endpoint.png" alt="You can see it&#39;s 90 degrees out. Also the endpoint for the IK service is between the ends of the grippers, while Unity thinks it&#39;s the centroid(?)"></p>
<p>I have set it up so that any change to the number of targets in the queue will publish a message containing the pose of the frontmost (topmost) element.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/15/Pose-message-from-Unity/" data-id="cj0i5jece0010ys9ryp61zuyd" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-CopyMemory-bug" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/15/CopyMemory-bug/">CopyMemory bug</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/15/CopyMemory-bug/" class="article-date">
  <time datetime="2017-03-14T23:30:28.000Z" itemprop="datePublished">Wed 15/03/2017 00:30</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I had a bug for many many hours, took me a while to narrow down.<br>I verified that everything worked perfectly at home.<br>However, in the lab, there was some strange behaviour with the shared memory for the hand poses.<br><code>CopyMemory</code> is defined on <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366535" target="_blank" rel="external">MSDN</a> like this:<br><figure class="highlight cpp"><figcaption><span>CopyMemory definition</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CopyMemory</span><span class="params">(</span></span></div><div class="line">  _In_       PVOID  Destination,</div><div class="line">  _In_ <span class="keyword">const</span> VOID   *Source,</div><div class="line">  _In_       SIZE_T Length</div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>I encapsulated the memory functions in a class for my ROS node.<br><figure class="highlight cpp"><figcaption><span>Single byte reading function</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">uint8_t</span> FileMapping::read_data(<span class="keyword">int</span> offset) &#123;</div><div class="line">	CopyMemory(data, buffer+offset, <span class="number">1</span>);</div><div class="line">	<span class="keyword">return</span> data[<span class="number">0</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>However, to get things to work correctly in the lab, I had to half the offset parameter.<br><figure class="highlight cpp"><figcaption><span>Modified line</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CopyMemory(data, buffer+(offset/<span class="number">2</span>), <span class="number">1</span>);</div></pre></td></tr></table></figure></p>
<p>This problem also occurs in a <code>float FileMapping::read_data_float(int offset)</code> function.<br>I’ve been careful to use <code>sizeof(float)</code> etc. and not assume sizes of things (although I have checked, and it is defined as 4 bytes everywhere).</p>
<p>This fix works so I’ll leave it as this, and this is the first place to look when the problem surfaces again.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/15/CopyMemory-bug/" data-id="cj0i5jea60005ys9rrhm4oz4f" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Live-joint-data" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/08/Live-joint-data/">Live joint data</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/08/Live-joint-data/" class="article-date">
  <time datetime="2017-03-08T10:51:47.000Z" itemprop="datePublished">Wed 08/03/2017 10:51</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <p>I ran the new code and project in the robot lab.<br>I appears that the jerky motion exhibited by the <code>rosbag</code> was related to the recording.<br>The computer running <code>roscore</code> connected to baxter is not connected directly to the Unity PC, but they are in the same network.<br>As there are no problems detected so far, the URDF data contained in Baxter matches the URDF file in the Unity project.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/IKGjTFgAbt4" frameborder="0" allowfullscreen></iframe></div>
<p>I got the ROSnode application to open with Unity, and close when the editor is stopped.<br>There isn’t any kind of message to say when it’s ready. If it’s not ready, the shared memory is mapped after a couple of failed attempts, but a 500ms delay has been added to make sure it connects first time.</p>
<p>Initiallly I made it so a window doesn’t open at all, now it seems like internal process.<br>Any output is printed to the Unity Editor log. It’s redirected so if the window was visible there wouldn’t be anything printed anyway.<br>It’s also colour coded so it’s easy to see where messages are coming from.<br>However, when doing this, the serial client loses synchronisation after around 20 seconds for some reason.<br>I suspect it’s to do with an issue redirecting standard output and error, I didn’t get a problem when running it as before.<br>Disabling this functionality for now.</p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/08/Live-joint-data/" data-id="cj0i5jebq000mys9rv0fbxrmg" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  
    <article id="post-Memory-Structure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Robotic-Telepresence/2017/03/02/Memory-Structure/">Memory structure</a>
    </h1>
  

      </header>
    
  <div class="article-meta">
    <a href="/Robotic-Telepresence/2017/03/02/Memory-Structure/" class="article-date">
  <time datetime="2017-03-02T22:47:09.000Z" itemprop="datePublished">Thu 02/03/2017 22:47</time>
</a>
    
  </div>
  <div class="article-entry" itemprop="articleBody">
    
      <h4 id="Baxter’s-Hands"><a href="#Baxter’s-Hands" class="headerlink" title="Baxter’s Hands"></a>Baxter’s Hands</h4><p>On examining the <code>URDF</code>, the different type of movement the hands have is called <code>prismatic</code>, as opposed to <code>revolute</code> for all other movable joints.<br>I’ve addded the functionality to read the messages from a topic. The rosbag only publishes one gripper for each hand, because the <code>urdf</code> talles the other to “mimic” the other one but with mirrored motion.<br>While trying to get this to work, I decided the structure of the shared memory needed to be improved.</p>
<h4 id="Proposed-structure"><a href="#Proposed-structure" class="headerlink" title="Proposed structure"></a>Proposed structure</h4><blockquote>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Length</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>How many joints <code>n</code></td>
<td>Static</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>Joint name length <code>l</code></td>
<td>Static. Goes down hierarchy, then alphabetically</td>
</tr>
<tr>
<td>2</td>
<td><code>l</code></td>
<td>Joint name</td>
<td>Mirrors joint name order</td>
</tr>
<tr>
<td></td>
<td></td>
<td><em>(other joint names, lengths)</em></td>
<td></td>
</tr>
<tr>
<td><code>n*(l+1)</code></td>
<td>4</td>
<td>Joint position</td>
<td>double in msg, truncated to float, as 4 bytes</td>
</tr>
<tr>
<td></td>
<td></td>
<td><em>(other joint positions)</em></td>
<td></td>
</tr>
<tr>
<td><code>n*(l+5)</code></td>
<td>-</td>
<td>End of data</td>
</tr>
</tbody>
</table>
</blockquote>
<p>The Unity project SHOULD! be able to dynamically associate the related <code>GameObjects</code>, as the names should match perfectly.<br>It could then notify the developer of any conflicts.</p>
<h4 id="NEW-proposed-structure"><a href="#NEW-proposed-structure" class="headerlink" title="NEW proposed structure"></a>NEW proposed structure</h4><p>I realised that as you won’t know the names in advance, each one will be added to a list (vector <span class="github-emoji" title=":wink:" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f609.png?v7">&#x1f609;</span>) of known joints as they come in.<br>This means the offsets can’t be set on startup.<br>I’ll probably have to create objects in a vector for each joint:</p>
<blockquote>
<ul>
<li>Vector<object type=""><ul>
<li><strong>Joint object</strong></li>
<li>Name</li>
<li>Offset of position</li>
</ul>
</object></li>
</ul>
</blockquote>
<p>Each message will have to be compared to the list of objects, but the data for that comes in every message anyway so the bottleneck should still be in the receiving of messages.</p>
<blockquote>
<table>
<thead>
<tr>
<th>Joint number <code>n</code></th>
<th>Offset</th>
<th>Length</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>-</td>
<td>0</td>
<td>1</td>
<td>Number of joints</td>
<td>Will increase as more are added</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>4</td>
<td>Joint position</td>
<td>Joint name to follow</td>
</tr>
<tr>
<td></td>
<td>5</td>
<td>1</td>
<td>Joint name length <code>l</code></td>
<td>Need to know this to read the name</td>
</tr>
<tr>
<td></td>
<td>6</td>
<td><code>l</code></td>
<td>Joint name</td>
<td>We know how many to read</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>1+<code>5n</code>+<code>l</code></td>
<td></td>
<td>Joint position</td>
<td>etc.</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<p>After some head scratching (for a few days), I managed to get it working.<br>It showed me that my combined URDF was incorrect; I had replaced <code>${side}</code> with “right” and “left”, and it should have been “r” and “l”.<br><img src="/Robotic-Telepresence/2017/03/02/Memory-Structure/Dynamic Objects.png" alt="This list is empty before running"></p>

    
  </div>
  <footer class="article-footer">
    <a data-url="https://celynwalters.github.io/Robotic-Telepresence/Robotic-Telepresence/2017/03/02/Memory-Structure/" data-id="cj0i5jec1000qys9rqimlvav1" class="article-share-link">Share</a>
    
     
  </footer>
  
</article>



  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/Robotic-Telepresence/page/2/">2</a><a class="page-number" href="/Robotic-Telepresence/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/Robotic-Telepresence/page/9/">9</a><a class="extend next" rel="next" href="/Robotic-Telepresence/page/2/">Next &raquo;</a>
  </nav>

</section>
        <!-- MANUALLY ADDED FOR GANTT CHART -->
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/02/">February 2017</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/12/">December 2016</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/11/">November 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/Robotic-Telepresence/archives/2016/10/">October 2016</a><span class="archive-list-count">14</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Celyn Walters<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/Robotic-Telepresence/" class="mobile-nav-link">Home</a>
  
    <a href="/Robotic-Telepresence/Project-objectives" class="mobile-nav-link">Project Objectives</a>
  
    <a href="https://www.teamgantt.com/gantt/schedule/?ids=702976&public_keys=1UNWW0SIdEwg&zoom=w90&font_size=12&estimated_hours=0&assigned_resources=0&percent_complete=0&documents=0&comments=0&col_width=255&menu_view=0&resource_filter=1&name_in_bar=0&name_next_to_bar=0&resource_names=1" class="mobile-nav-link">Gantt Chart</a>
  
    <a href="/Robotic-Telepresence/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/Robotic-Telepresence/fancybox/jquery.fancybox.css">
  <script src="/Robotic-Telepresence/fancybox/jquery.fancybox.pack.js"></script>


<script src="/Robotic-Telepresence/js/script.js"></script>

  </div>
</body>
</html>
